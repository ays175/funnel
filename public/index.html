<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&display=swap" rel="stylesheet"/>
    <title>Funnel</title>
    <style>
      :root {
        /* Enhanced color palette */
        --bg: hsl(260, 45%, 5%);
        --bg-elevated: hsl(260, 40%, 8%);
        --text: hsl(240, 20%, 98%);
        --text-muted: hsl(240, 10%, 70%);
        --text-subtle: hsl(240, 8%, 55%);
        --border: hsla(260, 40%, 80%, 0.08);
        --border-strong: hsla(260, 40%, 80%, 0.15);
        
        /* Purple gradient system */
        --primary-50: hsl(270, 100%, 98%);
        --primary-500: hsl(270, 91%, 65%);
        --primary-600: hsl(271, 81%, 56%);
        --primary-700: hsl(272, 71%, 47%);
        
        /* Accent */
        --accent-pink: hsl(330, 81%, 60%);
        --accent-cyan: hsl(190, 90%, 60%);
        
        /* Surfaces */
        --surface-glass: hsla(260, 40%, 95%, 0.04);
        --surface-glass-hover: hsla(260, 40%, 95%, 0.06);
        
        /* Shadows */
        --shadow-sm: 0 2px 8px hsla(260, 50%, 10%, 0.3);
        --shadow-md: 0 4px 16px hsla(260, 50%, 10%, 0.4), 0 2px 4px hsla(260, 50%, 5%, 0.2);
        --shadow-lg: 0 12px 32px hsla(260, 50%, 10%, 0.5), 0 4px 8px hsla(260, 50%, 5%, 0.3);
        --shadow-purple: 0 8px 24px hsla(270, 91%, 50%, 0.35);
        
        /* Spacing scale */
        --space-1: 4px;
        --space-2: 8px;
        --space-3: 12px;
        --space-4: 16px;
        --space-5: 24px;
        --space-6: 32px;
        --space-8: 48px;
        --space-10: 64px;
        
        /* Radius */
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --radius-xl: 20px;
        --radius-full: 9999px;
        
        /* Transitions */
        --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      * { 
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        margin: 0;
        font-family: "Sora", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-size: 15px;
        line-height: 1.6;
        color: var(--text);
        background: radial-gradient(ellipse 1200px 800px at 30% 0%, hsl(270, 60%, 15%) 0%, hsl(260, 50%, 8%) 50%, var(--bg) 100%);
        min-height: 100vh;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .container {
        max-width: 920px;
        margin: 0 auto;
        padding: var(--space-8) var(--space-5) var(--space-10);
      }

      /* Typography */
      h1 { 
        font-size: clamp(28px, 5vw, 36px);
        margin: 0 0 var(--space-2);
        font-weight: 700;
        letter-spacing: -0.02em;
        line-height: 1.2;
      }

      h2 { 
        font-size: 20px;
        margin: var(--space-6) 0 var(--space-3);
        font-weight: 600;
        letter-spacing: -0.01em;
        line-height: 1.3;
      }

      h3 {
        font-size: 17px;
        font-weight: 600;
        letter-spacing: -0.01em;
        margin: var(--space-4) 0 var(--space-2);
      }

      .muted { 
        color: var(--text-muted);
        font-size: 14px;
        line-height: 1.5;
      }

      .row { margin: var(--space-4) 0; }

      label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: var(--space-2);
        color: var(--text-muted);
        letter-spacing: 0.01em;
      }

      /* Cards & Surfaces */
      .card {
        border: 1px solid var(--border-strong);
        padding: var(--space-5);
        border-radius: var(--radius-lg);
        background: linear-gradient(
          135deg,
          hsla(260, 60%, 95%, 0.08) 0%,
          hsla(260, 40%, 95%, 0.04) 100%
        );
        backdrop-filter: blur(12px);
        box-shadow: var(--shadow-md);
        transition: transform var(--transition-base), box-shadow var(--transition-base);
      }

      .card:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-lg);
      }

      .facet-card {
        margin-top: var(--space-4);
        animation: fadeIn var(--transition-slow) ease-out;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* Inputs */
      textarea, input[type="text"] {
        width: 100%;
        padding: var(--space-3) var(--space-4);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 15px;
        font-family: inherit;
        color: var(--text);
        background: var(--surface-glass);
        backdrop-filter: blur(8px);
        transition: border-color var(--transition-fast), background var(--transition-fast);
        resize: vertical;
      }

      textarea {
        min-height: 120px;
        line-height: 1.6;
      }

      textarea:focus, input[type="text"]:focus {
        outline: none;
        border-color: var(--primary-500);
        background: var(--surface-glass-hover);
        box-shadow: 0 0 0 3px hsla(270, 91%, 65%, 0.12);
      }

      textarea::placeholder, input::placeholder { 
        color: var(--text-subtle);
      }

      /* Chips */
      .chip {
        display: inline-flex;
        align-items: center;
        margin: var(--space-2) var(--space-2) var(--space-2) 0;
        padding: var(--space-2) var(--space-4);
        border: 1px solid var(--border);
        border-radius: var(--radius-full);
        background: var(--surface-glass);
        backdrop-filter: blur(8px);
        font-size: 14px;
        font-weight: 500;
        color: var(--text);
        cursor: pointer;
        transition: all var(--transition-fast);
        user-select: none;
        white-space: nowrap;
      }

      .chip:hover {
        transform: translateY(-2px) scale(1.02);
        border-color: var(--border-strong);
        background: var(--surface-glass-hover);
        box-shadow: var(--shadow-sm);
      }

      .chip:active {
        transform: translateY(0) scale(0.98);
      }

      .chip.active {
        background: linear-gradient(135deg, var(--primary-600) 0%, var(--accent-pink) 100%);
        border-color: transparent;
        color: white;
        font-weight: 600;
        box-shadow: var(--shadow-purple);
      }

      .chip.active:hover {
        transform: translateY(-2px) scale(1.02);
        filter: brightness(1.1);
      }

      .choices { 
        margin-top: var(--space-3);
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
      }

      .subchoices { 
        margin-left: var(--space-5);
        margin-top: var(--space-2);
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
      }

      /* Buttons */
      button {
        padding: var(--space-3) var(--space-5);
        border: 1px solid var(--border-strong);
        border-radius: var(--radius-md);
        background: var(--surface-glass);
        backdrop-filter: blur(8px);
        cursor: pointer;
        font-size: 15px;
        font-weight: 600;
        font-family: inherit;
        color: var(--text);
        transition: all var(--transition-fast);
        white-space: nowrap;
      }

      button:hover:not(:disabled) {
        transform: translateY(-1px);
        background: var(--surface-glass-hover);
        border-color: var(--primary-500);
        box-shadow: var(--shadow-sm);
      }

      button:active:not(:disabled) {
        transform: translateY(0);
      }

      button.primary {
        background: linear-gradient(135deg, var(--primary-600) 0%, var(--accent-pink) 100%);
        color: white;
        border: none;
        box-shadow: var(--shadow-purple);
      }

      button.primary:hover:not(:disabled) {
        transform: translateY(-2px);
        filter: brightness(1.1);
        box-shadow: 0 12px 32px hsla(270, 91%, 50%, 0.45);
      }

      button.orange {
        background: linear-gradient(135deg, hsl(25, 95%, 53%) 0%, hsl(15, 100%, 55%) 100%);
        color: white;
        border: none;
        box-shadow: 0 8px 24px hsla(25, 95%, 50%, 0.5);
        font-weight: 700;
      }

      button.orange:hover:not(:disabled) {
        transform: translateY(-2px) scale(1.02);
        filter: brightness(1.15);
        box-shadow: 0 12px 32px hsla(25, 95%, 50%, 0.6);
      }

      button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        transform: none !important;
      }

      .button-row { 
        display: flex;
        gap: var(--space-3);
        flex-wrap: wrap;
        margin: var(--space-4) 0;
      }

      .nav-row { 
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--space-3);
      }

      /* Stepper */
      .stepper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-4);
        background: var(--surface-glass);
        backdrop-filter: blur(12px);
        border: 1px solid var(--border);
        padding: var(--space-3) var(--space-4);
        border-radius: var(--radius-md);
      }

      /* Selections */
      .summary {
        border-top: 1px solid var(--border);
        margin-top: var(--space-6);
        padding-top: var(--space-5);
      }

      .selection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: var(--space-4);
        margin-top: var(--space-3);
      }

      .selection-card {
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: var(--space-4);
        background: var(--surface-glass);
        backdrop-filter: blur(8px);
        transition: all var(--transition-base);
      }

      .selection-card:hover {
        border-color: var(--border-strong);
        background: var(--surface-glass-hover);
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
      }

      .selection-card .choices { 
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
        margin-top: var(--space-2);
      }

      /* Sticky Actions */
      .sticky-actions {
        position: sticky;
        bottom: 0;
        background: hsla(260, 45%, 6%, 0.95);
        backdrop-filter: blur(16px);
        border-top: 1px solid var(--border-strong);
        padding: var(--space-4);
        margin: var(--space-6) calc(-1 * var(--space-5)) calc(-1 * var(--space-10));
        box-shadow: 0 -8px 24px hsla(0, 0%, 0%, 0.3);
      }

      /* Answer */
      .answer-card {
        background: var(--surface-glass);
        backdrop-filter: blur(12px);
        border: 1px solid var(--border-strong);
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        box-shadow: var(--shadow-md);
      }

      .answer-section { 
        margin-bottom: var(--space-5);
      }

      .answer-section h3 { 
        margin: var(--space-4) 0 var(--space-2);
        font-size: 17px;
        color: var(--primary-50);
      }

      .answer-section p { 
        margin: var(--space-2) 0;
        line-height: 1.7;
      }

      .answer-list { 
        margin: var(--space-2) 0 var(--space-2) var(--space-6);
        line-height: 1.7;
      }

      .answer-bullets li,
      .answer-steps li { 
        margin-bottom: var(--space-3);
      }

      .answer-steps li strong { 
        margin-right: var(--space-2);
        color: var(--primary-500);
      }

      .answer-paragraphs p { 
        margin-bottom: var(--space-4);
        line-height: 1.7;
      }

      .answer-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: var(--space-3);
        font-size: 14px;
        border-radius: var(--radius-md);
        overflow: hidden;
      }

      .answer-table td {
        border: 1px solid var(--border);
        padding: var(--space-3);
      }

      .answer-table tr:nth-child(even) { 
        background: var(--surface-glass);
      }

      /* Markdown */
      .markdown h1, .markdown h2, .markdown h3 {
        margin: var(--space-5) 0 var(--space-3);
        color: var(--text);
      }

      .markdown p { 
        margin: var(--space-3) 0;
        line-height: 1.7;
      }

      .markdown ul, .markdown ol { 
        margin: var(--space-3) 0 var(--space-3) var(--space-6);
        line-height: 1.7;
      }

      .markdown li {
        margin-bottom: var(--space-2);
      }

      .markdown blockquote {
        margin: var(--space-4) 0;
        padding: var(--space-3) var(--space-4);
        border-left: 3px solid var(--primary-500);
        background: var(--surface-glass);
        border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      }

      .error { 
        color: hsl(0, 84%, 80%);
        font-size: 14px;
        margin-top: var(--space-3);
        padding: var(--space-3) var(--space-4);
        background: hsla(0, 84%, 50%, 0.1);
        border: 1px solid hsla(0, 84%, 50%, 0.3);
        border-radius: var(--radius-md);
      }

      pre { 
        white-space: pre-wrap;
        background: var(--surface-glass);
        backdrop-filter: blur(8px);
        padding: var(--space-4);
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
        font-size: 13px;
        line-height: 1.6;
        overflow-x: auto;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .container { 
          padding: var(--space-5) var(--space-4) var(--space-8);
        }
        
        h1 { font-size: 28px; }
        h2 { font-size: 18px; }
        
        .button-row { 
          flex-direction: column;
        }
        
        button { 
          width: 100%;
        }
        
        .selection-grid {
          grid-template-columns: 1fr;
        }
        
        .nav-row {
          flex-wrap: wrap;
        }
        
        .sticky-actions {
          margin-left: calc(-1 * var(--space-4));
          margin-right: calc(-1 * var(--space-4));
        }
      }

      @media (max-width: 480px) {
        .container {
          padding: var(--space-4) var(--space-3) var(--space-6);
        }
        
        .chip {
          font-size: 13px;
          padding: 6px var(--space-3);
        }
      }

      /* Accessibility */
      *:focus-visible {
        outline: 2px solid var(--primary-500);
        outline-offset: 2px;
      }

      button:focus-visible,
      .chip:focus-visible {
        outline: 2px solid var(--primary-500);
        outline-offset: 2px;
      }

      /* Loading state */
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }

      button:disabled {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const API_BASE = "https://funnel-production-859a.up.railway.app";

      function titleCase(value) {
        return String(value)
          .replace(/_/g, " ")
          .split(" ")
          .filter(Boolean)
          .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
          .join(" ");
      }

      function Screen1({
        query,
        setQuery,
        baseSelections,
        updateBaseSelection,
        domainHint,
        setDomainHint,
        handleDiscover,
        loading,
        error,
      }) {
        return (
          <div>
            <h1>Funnel</h1>
            <div className="muted">API: {API_BASE}</div>
            <div className="row">
              <label>Query</label>
              <textarea
                value={query}
                onChange={(e) => setQuery(e.target.value)}
                placeholder="Ask a question..."
              />
            </div>
            <div className="row card">
              <div className="row">
                <strong>Audience</strong>
                {["beginner", "intermediate", "expert", "executive"].map((v) => (
                  <span
                    className={`chip ${baseSelections.audience === v ? "active" : ""}`}
                    key={v}
                    role="button"
                    tabIndex={0}
                    onClick={() => updateBaseSelection("audience", v)}
                    onKeyDown={(e) => e.key === "Enter" && updateBaseSelection("audience", v)}
                  >
                    {titleCase(v)}
                  </span>
                ))}
              </div>
              <div className="row">
                <strong>Format</strong>
                {["bullets", "steps", "table", "paragraphs"].map((v) => (
                  <span
                    className={`chip ${baseSelections.format === v ? "active" : ""}`}
                    key={v}
                    role="button"
                    tabIndex={0}
                    onClick={() => updateBaseSelection("format", v)}
                    onKeyDown={(e) => e.key === "Enter" && updateBaseSelection("format", v)}
                  >
                    {titleCase(v)}
                  </span>
                ))}
              </div>
              <div className="row">
                <strong>Length</strong>
                {["300 words", "600 words", "900 words", "1200 words"].map((v) => (
                  <span
                    className={`chip ${baseSelections.length === v ? "active" : ""}`}
                    key={v}
                    role="button"
                    tabIndex={0}
                    onClick={() => updateBaseSelection("length", v)}
                    onKeyDown={(e) => e.key === "Enter" && updateBaseSelection("length", v)}
                  >
                    {titleCase(v)}
                  </span>
                ))}
              </div>
            </div>
            <div className="row">
              <label>Domain hint (optional)</label>
              <input
                type="text"
                value={domainHint}
                onChange={(e) => setDomainHint(e.target.value)}
                placeholder="finance, legal, universal"
              />
            </div>
            <div className="button-row">
              <button className="primary" onClick={handleDiscover} disabled={loading}>
                {loading ? "Mapping..." : "Map the Field"}
              </button>
            </div>
            {error && <div className="error">{error}</div>}
          </div>
        );
      }

        function FacetChoices({ facet, facetSelections, updateFacetSelection, updateFacetCustom }) {
        const data = facetSelections[facet.id] || { values: new Set(), custom: "" };
        const choices = Array.isArray(facet.choices) ? facet.choices : [];
        const suggested = choices.length
          ? choices
          : (facet.suggested_values || []).map((v) => ({ value: v, subchoices: [] }));

        return (
          <div className="choices">
            {suggested.map((choice) => {
              const isActive = data.values.has(choice.value);
              return (
                <div key={choice.value} className="row">
                  <span
                    className={`chip ${isActive ? "active" : ""}`}
                    role="button"
                    tabIndex={0}
                    onClick={() => {
                      if (choice.value === "all options") {
                        data.values.forEach((v) => updateFacetSelection(facet.id, v, false));
                        updateFacetSelection(facet.id, choice.value, !isActive);
                        return;
                      }
                      updateFacetSelection(facet.id, choice.value, !isActive);
                      if (!isActive) {
                        updateFacetSelection(facet.id, "all options", false);
                      }
                    }}
                    onKeyDown={(e) => e.key === "Enter" && updateFacetSelection(facet.id, choice.value, !isActive)}
                  >
                    {titleCase(choice.value)}
                  </span>
                  {choice.subchoices && choice.subchoices.length > 0 && isActive && (
                    <div className="subchoices">
                      {choice.subchoices.map((sub) => {
                        const subValue = `${choice.value} > ${sub}`;
                        const subActive = data.values.has(subValue);
                        return (
                          <span
                            className={`chip ${subActive ? "active" : ""}`}
                            key={sub}
                            role="button"
                            tabIndex={0}
                            onClick={() => {
                              updateFacetSelection(facet.id, choice.value, true);
                              updateFacetSelection(facet.id, subValue, !subActive);
                              if (!subActive) {
                                updateFacetSelection(facet.id, "all options", false);
                              }
                            }}
                            onKeyDown={(e) => e.key === "Enter" && updateFacetSelection(facet.id, subValue, !subActive)}
                          >
                            {titleCase(sub)}
                          </span>
                        );
                      })}
                    </div>
                  )}
                </div>
              );
            })}
            <div className="row">
              <input
                type="text"
                placeholder="custom value (optional)"
                value={data.custom}
                onChange={(e) => updateFacetCustom(facet.id, e.target.value)}
              />
            </div>
          </div>
        );
      }

        function Screen2({
        totalFacets,
        currentIndex,
        setCurrentIndex,
        currentFacet,
        requestId,
        handleRefine,
        handleAnswer,
        loading,
        error,
        facetSelections,
        updateFacetSelection,
        updateFacetCustom,
        selectionsForApi,
      }) {
        return (
          <div>
            <div className="stepper">
              <div className="muted">Request: {requestId}</div>
            </div>

            <div className="button-row">
              <button className="orange" onClick={handleRefine} disabled={loading}>
                Set More Targets
              </button>
              <button className="primary" onClick={handleAnswer} disabled={loading}>Proceed</button>
            </div>

            {currentFacet ? (
              <div className="card facet-card">
                <h2>
                  {currentFacet.title}{" "}
                  <span className="muted">
                    ({currentIndex + 1}/{totalFacets})
                  </span>
                </h2>
                <div className="muted">{currentFacet.question}</div>
                <div className="muted">{currentFacet.reason}</div>
                <FacetChoices
                  facet={currentFacet}
                  facetSelections={facetSelections}
                  updateFacetSelection={updateFacetSelection}
                  updateFacetCustom={updateFacetCustom}
                />
              </div>
            ) : (
              <div className="muted">No facets yet.</div>
            )}

            <div className="sticky-actions">
              <div className="button-row nav-row">
                <button
                  onClick={() => setCurrentIndex((prev) => Math.max(0, prev - 1))}
                  disabled={currentIndex === 0}
                >
                  Previous
                </button>
                <button className="orange" onClick={handleRefine} disabled={loading}>
                  Set More Targets
                </button>
                <button className="primary" onClick={handleAnswer} disabled={loading}>Proceed</button>
                <button
                  onClick={() => setCurrentIndex((prev) => Math.min(totalFacets - 1, prev + 1))}
                  disabled={currentIndex >= totalFacets - 1}
                >
                  Next
                </button>
              </div>
            </div>

            <div className="summary">
              <h2>Selections</h2>
              {selectionsForApi().length === 0 ? (
                <div className="muted">No selections yet.</div>
              ) : (
                <div className="selection-grid">
                  {selectionsForApi().map((item) => {
                    const rawValues = String(item.value)
                      .split(",")
                      .map((val) => val.trim())
                      .filter(Boolean);
                    const tree = {};
                    rawValues.forEach((val) => {
                      if (val.includes(" > ")) {
                        const [parent, child] = val.split(" > ").map((v) => v.trim());
                        if (!tree[parent]) tree[parent] = { children: [] };
                        if (!tree[parent].children.includes(child)) tree[parent].children.push(child);
                      } else {
                        if (!tree[val]) tree[val] = { children: [] };
                      }
                    });

                    return (
                      <div key={item.id} className="selection-card">
                        <div className="muted">{titleCase(item.id)}</div>
                        <div className="choices">
                          {Object.entries(tree).map(([parent, data]) => (
                            <div key={parent} className="row">
                              <span className="chip active">{titleCase(parent)}</span>
                              {data.children.length > 0 && (
                                <div className="subchoices">
                                  {data.children.map((child) => (
                                    <span className="chip active" key={child}>
                                      {titleCase(child)}
                                    </span>
                                  ))}
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>

            {error && <div className="error">{error}</div>}
          </div>
        );
      }

      function Screen3({ answer, trace, setScreen, answerMode, setAnswerMode }) {
        function escapeHtml(value) {
          return String(value)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        }

        function renderMarkdown(value) {
          const rawLines = String(value || "").split(/\n/);
          const htmlLines = [];
          let inList = false;
          let listType = "ul";

          const flushList = () => {
            if (inList) {
              htmlLines.push(listType === "ol" ? "</ol>" : "</ul>");
              inList = false;
            }
          };

          rawLines.forEach((raw) => {
            const line = raw.trim();
            if (!line) {
              flushList();
              return;
            }
            if (/^###\s+/.test(line)) {
              flushList();
              htmlLines.push(`<h3>${escapeHtml(line.replace(/^###\s+/, ""))}</h3>`);
              return;
            }
            if (/^##\s+/.test(line)) {
              flushList();
              htmlLines.push(`<h2>${escapeHtml(line.replace(/^##\s+/, ""))}</h2>`);
              return;
            }
            if (/^#\s+/.test(line)) {
              flushList();
              htmlLines.push(`<h1>${escapeHtml(line.replace(/^#\s+/, ""))}</h1>`);
              return;
            }
            if (/^>\s+/.test(line)) {
              flushList();
              htmlLines.push(`<blockquote>${escapeHtml(line.replace(/^>\s+/, ""))}</blockquote>`);
              return;
            }
            if (/^\d+\.\s+/.test(line)) {
              if (!inList || listType !== "ol") {
                flushList();
                inList = true;
                listType = "ol";
                htmlLines.push("<ol>");
              }
              htmlLines.push(`<li>${escapeHtml(line.replace(/^\d+\.\s+/, ""))}</li>`);
              return;
            }
            if (/^[-*•]\s+/.test(line)) {
              if (!inList || listType !== "ul") {
                flushList();
                inList = true;
                listType = "ul";
                htmlLines.push("<ul>");
              }
              htmlLines.push(`<li>${escapeHtml(line.replace(/^[-*•]\s+/, ""))}</li>`);
              return;
            }

            flushList();
            let safe = escapeHtml(line);
            safe = safe.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
            safe = safe.replace(/\*(.+?)\*/g, "<em>$1</em>");
            htmlLines.push(`<p>${safe}</p>`);
          });

          flushList();
          return htmlLines.join("");
        }

        return (
          <div>
            <div className="button-row row">
              <button onClick={() => setScreen(2)}>Back to facets</button>
            </div>
            <h1>Answer</h1>
            <div className="row">
              <strong>Presentation</strong>{" "}
              <span className={`chip ${answerMode === "plain" ? "active" : ""}`} role="button" tabIndex={0} onClick={() => setAnswerMode("plain")}>Plain</span>
              <span className={`chip ${answerMode === "markdown" ? "active" : ""}`} role="button" tabIndex={0} onClick={() => setAnswerMode("markdown")}>Markdown</span>
            </div>
            <div className="row">
              {answerMode === "plain" ? (
                <pre>{answer}</pre>
              ) : (
                <div className="answer-card markdown" dangerouslySetInnerHTML={{ __html: renderMarkdown(answer) }} />
              )}
            </div>
            <h2>Trace</h2>
            <pre>{JSON.stringify(trace, null, 2)}</pre>
          </div>
        );
      }

      function App() {
        const [screen, setScreen] = React.useState(1);
        const [loading, setLoading] = React.useState(false);
        const [error, setError] = React.useState("");
        const [requestId, setRequestId] = React.useState(null);
        const [facets, setFacets] = React.useState([]);
        const [currentIndex, setCurrentIndex] = React.useState(0);
        const [answer, setAnswer] = React.useState("");
        const [answerMode, setAnswerMode] = React.useState("markdown");
        const [trace, setTrace] = React.useState([]);

        const [query, setQuery] = React.useState("");
        const [domainHint, setDomainHint] = React.useState("");
        const [baseSelections, setBaseSelections] = React.useState({
          audience: "",
          format: "",
          length: "",
        });

        const [facetSelections, setFacetSelections] = React.useState({});

        const totalFacets = facets.length;
        const currentFacet = facets[currentIndex];

        function updateBaseSelection(key, value) {
          setBaseSelections((prev) => ({ ...prev, [key]: value }));
        }

        function updateFacetSelection(facetId, value, checked) {
          setFacetSelections((prev) => {
            const current = prev[facetId] || { values: new Set(), custom: "" };
            const nextValues = new Set(current.values);
            if (checked) {
              nextValues.add(value);
            } else {
              nextValues.delete(value);
            }
            return { ...prev, [facetId]: { ...current, values: nextValues } };
          });
        }

        function updateFacetCustom(facetId, customValue) {
          setFacetSelections((prev) => {
            const current = prev[facetId] || { values: new Set(), custom: "" };
            return { ...prev, [facetId]: { ...current, custom: customValue } };
          });
        }

        function selectionsForApi() {
          const selections = [];
          Object.entries(baseSelections).forEach(([id, value]) => {
            if (value) selections.push({ id, value });
          });

          Object.entries(facetSelections).forEach(([id, data]) => {
            const values = Array.from(data.values || []);
            if (data.custom) values.push(data.custom);
            const value = values.length ? values.join(", ") : null;
            if (value) selections.push({ id, value });
          });

          return selections;
        }

        async function handleDiscover() {
          setError("");
          setAnswer("");
          setTrace([]);
          if (!query.trim()) {
            setError("Please enter a query.");
            return;
          }
          setLoading(true);
          try {
            const res = await fetch(`${API_BASE}/api/discover`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                raw_query: query.trim(),
                domain_hint: domainHint.trim() || null,
              }),
            });
            const text = await res.text();
            if (!res.ok) {
              setError(text || "Discover failed.");
              return;
            }
            const data = JSON.parse(text);
            setRequestId(data.request_id);
            setFacets(data.facet_candidates || []);
            setCurrentIndex(0);
            setScreen(2);
          } catch (err) {
            setError("Discover failed.");
          } finally {
            setLoading(false);
          }
        }

        async function handleRefine() {
          if (!requestId) {
            setError("Please discover facets first.");
            return;
          }
          setLoading(true);
          setError("");
          try {
            const res = await fetch(`${API_BASE}/api/refine`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                request_id: requestId,
                facet_selections: selectionsForApi(),
                refine_round: 2,
              }),
            });
            const text = await res.text();
            if (!res.ok) {
              setError(text || "Refine failed.");
              return;
            }
            const data = JSON.parse(text);
            const nextFacets = data.facet_candidates || [];
            if (nextFacets.length) {
              setFacets((prev) => prev.concat(nextFacets));
              setCurrentIndex((prevIndex) => {
                const firstNewIndex = facets.length;
                return Math.max(firstNewIndex, prevIndex);
              });
            }
          } catch (err) {
            setError("Refine failed.");
          } finally {
            setLoading(false);
          }
        }

        async function handleAnswer() {
          if (!requestId) {
            setError("Please discover facets first.");
            return;
          }
          setLoading(true);
          setError("");
          try {
            const res = await fetch(`${API_BASE}/api/answer`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                request_id: requestId,
                facet_selections: selectionsForApi(),
              }),
            });
            const text = await res.text();
            if (!res.ok) {
              setError(text || "Answer failed.");
              return;
            }
            const data = JSON.parse(text);
            setAnswer(data.answer || "");
            setTrace(data.trace || []);
            setScreen(3);
          } catch (err) {
            setError("Answer failed.");
          } finally {
            setLoading(false);
          }
        }

        return (
          <div className="container">
            {screen === 1 && (
              <Screen1
                query={query}
                setQuery={setQuery}
                baseSelections={baseSelections}
                updateBaseSelection={updateBaseSelection}
                domainHint={domainHint}
                setDomainHint={setDomainHint}
                handleDiscover={handleDiscover}
                loading={loading}
                error={error}
              />
            )}
            {screen === 2 && (
              <Screen2
                totalFacets={totalFacets}
                currentIndex={currentIndex}
                setCurrentIndex={setCurrentIndex}
                currentFacet={currentFacet}
                requestId={requestId}
                handleRefine={handleRefine}
                handleAnswer={handleAnswer}
                loading={loading}
                error={error}
                facetSelections={facetSelections}
                updateFacetSelection={updateFacetSelection}
                updateFacetCustom={updateFacetCustom}
                selectionsForApi={selectionsForApi}
              />
            )}
            {screen === 3 && (
              <Screen3
                answer={answer}
                trace={trace}
                setScreen={setScreen}
                answerMode={answerMode}
                setAnswerMode={setAnswerMode}
              />
            )}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
