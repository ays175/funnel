<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
    <title>Funnel</title>
    <style>
      :root {
        --bg: #0b0616;
        --text: #f8fafc;
        --muted: #c7c9d9;
        --border: rgba(255,255,255,0.08);
        --primary: #8b5cf6;
        --primary-dark: #6d28d9;
        --surface: rgba(255,255,255,0.05);
        --card: rgba(255,255,255,0.07);
        --accent: #ec4899;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, Segoe UI, sans-serif;
        color: var(--text);
        background: radial-gradient(1000px 700px at 20% 0%, #2a1147 0%, #140d2b 45%, #0b0616 100%);
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 28px 20px 36px;
      }
      h1 { font-size: 26px; margin: 0 0 10px; font-weight: 700; }
      h2 { font-size: 18px; margin: 16px 0 8px; font-weight: 600; }
      .muted { color: var(--muted); font-size: 13px; }
      .card {
        border: 1px solid var(--border);
        padding: 16px;
        border-radius: 14px;
        background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
        box-shadow: 0 12px 30px rgba(6, 4, 15, 0.6);
      }
      .row { margin: 12px 0; }
      textarea, input[type="text"] {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid var(--border);
        border-radius: 10px;
        font-size: 15px;
        color: var(--text);
        background: var(--surface);
      }
      textarea::placeholder, input::placeholder { color: #9ca3af; }
      .chip {
        display: inline-flex;
        align-items: center;
        margin: 6px 8px 6px 0;
        padding: 8px 14px;
        border: 1px solid var(--border);
        border-radius: 999px;
        background: rgba(255,255,255,0.06);
        font-size: 14px;
        color: var(--text);
        cursor: pointer;
        transition: transform 0.08s ease, background 0.2s ease, border 0.2s ease;
        user-select: none;
      }
      .chip:hover { transform: translateY(-1px); }
      .chip.active {
        background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
        border-color: transparent;
        color: #fff;
        box-shadow: 0 8px 18px rgba(139,92,246,0.35);
      }
      .choices { margin-top: 8px; }
      .subchoices { margin-left: 18px; margin-top: 6px; }
      .button-row { display: flex; gap: 8px; flex-wrap: wrap; }
      .nav-row { display: flex; justify-content: space-between; align-items: center; }
      button {
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: rgba(255,255,255,0.06);
        cursor: pointer;
        font-size: 15px;
        color: var(--text);
        font-weight: 600;
      }
      button.primary {
        background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
        color: #fff;
        border: none;
        box-shadow: 0 10px 22px rgba(139,92,246,0.45);
      }
      button.primary:hover { filter: brightness(1.05); }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .stepper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        background: rgba(255,255,255,0.05);
        border: 1px solid var(--border);
        padding: 10px 12px;
        border-radius: 12px;
      }
      .facet-card { margin-top: 8px; }
      .summary {
        border-top: 1px solid var(--border);
        margin-top: 16px;
        padding-top: 12px;
      }
      .selection-grid {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        padding-bottom: 6px;
      }
      .selection-card {
        min-width: 220px;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: rgba(255,255,255,0.04);
      }
      .selection-card .choices { display: flex; flex-wrap: wrap; gap: 6px; }
      .selection-card .row { margin: 6px 0; }
      .sticky-actions {
        position: sticky;
        bottom: 0;
        background: rgba(15,11,31,0.95);
        backdrop-filter: blur(8px);
        border-top: 1px solid var(--border);
        padding: 12px;
        margin-top: 16px;
      }
      .error { color: #fca5a5; font-size: 13px; margin-top: 6px; }
      pre { white-space: pre-wrap; background: var(--surface); padding: 12px; border-radius: 8px; }
      .answer-card {
        background: rgba(255,255,255,0.06);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 18px;
      }
      .answer-section { margin-bottom: 14px; }
      .answer-section h3 { margin: 0 0 6px; font-size: 16px; }
      .answer-section p { margin: 6px 0; line-height: 1.5; }
      .answer-list { margin: 6px 0 6px 18px; }
      .answer-bullets li,
      .answer-steps li { margin-bottom: 8px; }
      .answer-steps li strong { margin-right: 6px; }
      .answer-paragraphs p { margin-bottom: 10px; }
      .answer-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
        font-size: 14px;
      }
      .answer-table td {
        border: 1px solid var(--border);
        padding: 8px;
      }
      .answer-table tr:nth-child(even) { background: rgba(255,255,255,0.03); }
      .markdown h1, .markdown h2, .markdown h3 {
        margin: 12px 0 6px;
      }
      .markdown p { margin: 8px 0; line-height: 1.6; }
      .markdown ul, .markdown ol { margin: 8px 0 8px 18px; }
      .markdown blockquote {
        margin: 8px 0;
        padding: 8px 12px;
        border-left: 3px solid var(--border);
        background: rgba(255,255,255,0.04);
      }

      @media (max-width: 640px) {
        .container { padding: 14px; }
        .button-row { flex-direction: column; }
        button { width: 100%; }
        .pill { display: block; width: 100%; }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const API_BASE = "https://funnel-production-859a.up.railway.app";

      function titleCase(value) {
        return String(value)
          .replace(/_/g, " ")
          .split(" ")
          .filter(Boolean)
          .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
          .join(" ");
      }

      function Screen1({
        query,
        setQuery,
        baseSelections,
        updateBaseSelection,
        domainHint,
        setDomainHint,
        handleDiscover,
        loading,
        error,
      }) {
        return (
          <div>
            <h1>Funnel</h1>
            <div className="muted">API: {API_BASE}</div>
            <div className="row">
              <label>Query</label>
              <textarea
                value={query}
                onChange={(e) => setQuery(e.target.value)}
                placeholder="Ask a question..."
              />
            </div>
            <div className="row card">
              <div className="row">
                <strong>Audience</strong>
                {["beginner", "intermediate", "expert", "executive"].map((v) => (
                  <span
                    className={`chip ${baseSelections.audience === v ? "active" : ""}`}
                    key={v}
                    role="button"
                    tabIndex={0}
                    onClick={() => updateBaseSelection("audience", v)}
                    onKeyDown={(e) => e.key === "Enter" && updateBaseSelection("audience", v)}
                  >
                    {titleCase(v)}
                  </span>
                ))}
              </div>
              <div className="row">
                <strong>Format</strong>
                {["bullets", "steps", "table", "paragraphs"].map((v) => (
                  <span
                    className={`chip ${baseSelections.format === v ? "active" : ""}`}
                    key={v}
                    role="button"
                    tabIndex={0}
                    onClick={() => updateBaseSelection("format", v)}
                    onKeyDown={(e) => e.key === "Enter" && updateBaseSelection("format", v)}
                  >
                    {titleCase(v)}
                  </span>
                ))}
              </div>
              <div className="row">
                <strong>Length</strong>
                {["300 words", "600 words", "900 words", "1200 words"].map((v) => (
                  <span
                    className={`chip ${baseSelections.length === v ? "active" : ""}`}
                    key={v}
                    role="button"
                    tabIndex={0}
                    onClick={() => updateBaseSelection("length", v)}
                    onKeyDown={(e) => e.key === "Enter" && updateBaseSelection("length", v)}
                  >
                    {titleCase(v)}
                  </span>
                ))}
              </div>
            </div>
            <div className="row">
              <label>Domain hint (optional)</label>
              <input
                type="text"
                value={domainHint}
                onChange={(e) => setDomainHint(e.target.value)}
                placeholder="finance, legal, universal"
              />
            </div>
            <div className="button-row">
              <button className="primary" onClick={handleDiscover} disabled={loading}>
                {loading ? "Discovering..." : "Discover facets"}
              </button>
            </div>
            {error && <div className="error">{error}</div>}
          </div>
        );
      }

        function FacetChoices({ facet, facetSelections, updateFacetSelection, updateFacetCustom }) {
        const data = facetSelections[facet.id] || { values: new Set(), custom: "" };
        const choices = Array.isArray(facet.choices) ? facet.choices : [];
        const suggested = choices.length
          ? choices
          : (facet.suggested_values || []).map((v) => ({ value: v, subchoices: [] }));

        return (
          <div className="choices">
            {suggested.map((choice) => {
              const isActive = data.values.has(choice.value);
              return (
                <div key={choice.value} className="row">
                  <span
                    className={`chip ${isActive ? "active" : ""}`}
                    role="button"
                    tabIndex={0}
                    onClick={() => {
                      if (choice.value === "all options") {
                        data.values.forEach((v) => updateFacetSelection(facet.id, v, false));
                        updateFacetSelection(facet.id, choice.value, !isActive);
                        return;
                      }
                      updateFacetSelection(facet.id, choice.value, !isActive);
                      if (!isActive) {
                        updateFacetSelection(facet.id, "all options", false);
                      }
                    }}
                    onKeyDown={(e) => e.key === "Enter" && updateFacetSelection(facet.id, choice.value, !isActive)}
                  >
                    {titleCase(choice.value)}
                  </span>
                  {choice.subchoices && choice.subchoices.length > 0 && isActive && (
                    <div className="subchoices">
                      {choice.subchoices.map((sub) => {
                        const subValue = `${choice.value} > ${sub}`;
                        const subActive = data.values.has(subValue);
                        return (
                          <span
                            className={`chip ${subActive ? "active" : ""}`}
                            key={sub}
                            role="button"
                            tabIndex={0}
                            onClick={() => {
                              updateFacetSelection(facet.id, choice.value, true);
                              updateFacetSelection(facet.id, subValue, !subActive);
                              if (!subActive) {
                                updateFacetSelection(facet.id, "all options", false);
                              }
                            }}
                            onKeyDown={(e) => e.key === "Enter" && updateFacetSelection(facet.id, subValue, !subActive)}
                          >
                            {titleCase(sub)}
                          </span>
                        );
                      })}
                    </div>
                  )}
                </div>
              );
            })}
            <div className="row">
              <input
                type="text"
                placeholder="custom value (optional)"
                value={data.custom}
                onChange={(e) => updateFacetCustom(facet.id, e.target.value)}
              />
            </div>
          </div>
        );
      }

        function Screen2({
        totalFacets,
        currentIndex,
        setCurrentIndex,
        currentFacet,
        requestId,
        handleRefine,
        handleAnswer,
        loading,
        error,
        facetSelections,
        updateFacetSelection,
        updateFacetCustom,
        selectionsForApi,
      }) {
        return (
          <div>
            <div className="stepper">
              <div className="muted">Request: {requestId}</div>
            </div>

            <div className="button-row">
              <button onClick={handleRefine} disabled={loading}>Narrow further</button>
              <button className="primary" onClick={handleAnswer} disabled={loading}>Proceed</button>
            </div>

            {currentFacet ? (
              <div className="card facet-card">
                <h2>
                  {currentFacet.title}{" "}
                  <span className="muted">
                    ({currentIndex + 1}/{totalFacets})
                  </span>
                </h2>
                <div className="muted">{currentFacet.question}</div>
                <div className="muted">{currentFacet.reason}</div>
                <FacetChoices
                  facet={currentFacet}
                  facetSelections={facetSelections}
                  updateFacetSelection={updateFacetSelection}
                  updateFacetCustom={updateFacetCustom}
                />
              </div>
            ) : (
              <div className="muted">No facets yet.</div>
            )}

            <div className="sticky-actions">
              <div className="button-row nav-row">
                <button
                  onClick={() => setCurrentIndex((prev) => Math.max(0, prev - 1))}
                  disabled={currentIndex === 0}
                >
                  Previous
                </button>
                <button onClick={handleRefine} disabled={loading}>Narrow further</button>
                <button className="primary" onClick={handleAnswer} disabled={loading}>Proceed</button>
                <button
                  onClick={() => setCurrentIndex((prev) => Math.min(totalFacets - 1, prev + 1))}
                  disabled={currentIndex >= totalFacets - 1}
                >
                  Next
                </button>
              </div>
            </div>

            <div className="summary">
              <h2>Selections</h2>
              {selectionsForApi().length === 0 ? (
                <div className="muted">No selections yet.</div>
              ) : (
                <div className="selection-grid">
                  {selectionsForApi().map((item) => {
                    const rawValues = String(item.value)
                      .split(",")
                      .map((val) => val.trim())
                      .filter(Boolean);
                    const tree = {};
                    rawValues.forEach((val) => {
                      if (val.includes(" > ")) {
                        const [parent, child] = val.split(" > ").map((v) => v.trim());
                        if (!tree[parent]) tree[parent] = { children: [] };
                        if (!tree[parent].children.includes(child)) tree[parent].children.push(child);
                      } else {
                        if (!tree[val]) tree[val] = { children: [] };
                      }
                    });

                    return (
                      <div key={item.id} className="selection-card">
                        <div className="muted">{titleCase(item.id)}</div>
                        <div className="choices">
                          {Object.entries(tree).map(([parent, data]) => (
                            <div key={parent} className="row">
                              <span className="chip active">{titleCase(parent)}</span>
                              {data.children.length > 0 && (
                                <div className="subchoices">
                                  {data.children.map((child) => (
                                    <span className="chip active" key={child}>
                                      {titleCase(child)}
                                    </span>
                                  ))}
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>

            {error && <div className="error">{error}</div>}
          </div>
        );
      }

      function Screen3({ answer, trace, setScreen, answerMode, setAnswerMode, baseSelections }) {
        const paragraphs = (answer || "").split(/\n{2,}/).filter(Boolean);
        const lines = (answer || "").split(/\n/);
        const hasBullets = lines.some((line) => /^[-*•]/.test(line.trim()));
        const sections = [];
        let current = { title: "", lines: [] };
        lines.forEach((line) => {
          const trimmed = line.trim();
          if (!trimmed) {
            if (current.lines.length) sections.push(current);
            current = { title: "", lines: [] };
            return;
          }
          if (trimmed.endsWith(":") && trimmed.length < 60) {
            if (current.lines.length) sections.push(current);
            current = { title: trimmed.replace(/:$/, ""), lines: [] };
            return;
          }
          current.lines.push(trimmed);
        });
        if (current.lines.length) sections.push(current);

        const formatMode = (baseSelections.format || "").toLowerCase();

        function escapeHtml(value) {
          return String(value)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        }

        function renderMarkdown(value) {
          const rawLines = String(value || "").split(/\n/);
          const htmlLines = [];
          let inList = false;
          let listType = "ul";

          const flushList = () => {
            if (inList) {
              htmlLines.push(listType === "ol" ? "</ol>" : "</ul>");
              inList = false;
            }
          };

          rawLines.forEach((raw) => {
            const line = raw.trim();
            if (!line) {
              flushList();
              return;
            }
            if (/^###\s+/.test(line)) {
              flushList();
              htmlLines.push(`<h3>${escapeHtml(line.replace(/^###\s+/, ""))}</h3>`);
              return;
            }
            if (/^##\s+/.test(line)) {
              flushList();
              htmlLines.push(`<h2>${escapeHtml(line.replace(/^##\s+/, ""))}</h2>`);
              return;
            }
            if (/^#\s+/.test(line)) {
              flushList();
              htmlLines.push(`<h1>${escapeHtml(line.replace(/^#\s+/, ""))}</h1>`);
              return;
            }
            if (/^>\s+/.test(line)) {
              flushList();
              htmlLines.push(`<blockquote>${escapeHtml(line.replace(/^>\s+/, ""))}</blockquote>`);
              return;
            }
            if (/^\d+\.\s+/.test(line)) {
              if (!inList || listType !== "ol") {
                flushList();
                inList = true;
                listType = "ol";
                htmlLines.push("<ol>");
              }
              htmlLines.push(`<li>${escapeHtml(line.replace(/^\d+\.\s+/, ""))}</li>`);
              return;
            }
            if (/^[-*•]\s+/.test(line)) {
              if (!inList || listType !== "ul") {
                flushList();
                inList = true;
                listType = "ul";
                htmlLines.push("<ul>");
              }
              htmlLines.push(`<li>${escapeHtml(line.replace(/^[-*•]\s+/, ""))}</li>`);
              return;
            }

            flushList();
            let safe = escapeHtml(line);
            safe = safe.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
            safe = safe.replace(/\*(.+?)\*/g, "<em>$1</em>");
            htmlLines.push(`<p>${safe}</p>`);
          });

          flushList();
          return htmlLines.join("");
        }

        function renderTable(rows) {
          return (
            <table className="answer-table">
              <tbody>
                {rows.map((row, idx) => (
                  <tr key={idx}>
                    {row.map((cell, cidx) => (
                      <td key={cidx}>{cell}</td>
                    ))}
                  </tr>
                ))}
              </tbody>
            </table>
          );
        }

        function structuredByFormat(sourceLines, sourceParagraphs) {
          if (formatMode === "table") {
            const rows = sourceLines
              .map((line) => line.trim())
              .filter(Boolean)
              .map((line) => {
                if (line.includes("|")) {
                  return line.split("|").map((c) => c.trim()).filter(Boolean);
                }
                if (line.includes(":")) {
                  const [left, ...rest] = line.split(":");
                  return [left.trim(), rest.join(":").trim()];
                }
                return [line];
              });
            return renderTable(rows);
          }

          if (formatMode === "steps") {
            const stepLines = sourceLines
              .map((line) => line.trim())
              .filter(Boolean)
              .map((line) => line.replace(/^[-*•]\s*/, ""));
            return (
              <ol className="answer-list answer-steps">
                {stepLines.map((line, idx) => (
                  <li key={idx}>
                    <strong>Step {idx + 1}.</strong> {line}
                  </li>
                ))}
              </ol>
            );
          }

          if (formatMode === "bullets") {
            const bulletLines = sourceLines
              .map((line) => line.trim())
              .filter(Boolean)
              .map((line) => line.replace(/^[-*•]\s*/, ""));
            return (
              <ul className="answer-list answer-bullets">
                {bulletLines.map((line, idx) => (
                  <li key={idx}>{line}</li>
                ))}
              </ul>
            );
          }

          // Paragraphs or default
          return (
            <div className="answer-paragraphs">
              {sourceParagraphs.map((para, idx) => <p key={idx}>{para}</p>)}
            </div>
          );
        }

        return (
          <div>
            <div className="button-row row">
              <button onClick={() => setScreen(2)}>Back to facets</button>
            </div>
            <h1>Answer</h1>
            <div className="row">
              <strong>Presentation</strong>{" "}
              <span className={`chip ${answerMode === "plain" ? "active" : ""}`} role="button" tabIndex={0} onClick={() => setAnswerMode("plain")}>Plain</span>
              <span className={`chip ${answerMode === "structured" ? "active" : ""}`} role="button" tabIndex={0} onClick={() => setAnswerMode("structured")}>Structured</span>
              <span className={`chip ${answerMode === "markdown" ? "active" : ""}`} role="button" tabIndex={0} onClick={() => setAnswerMode("markdown")}>Markdown</span>
            </div>
            <div className="row">
              {answerMode === "plain" ? (
                <pre>{answer}</pre>
              ) : answerMode === "markdown" ? (
                <div className="answer-card markdown" dangerouslySetInnerHTML={{ __html: renderMarkdown(answer) }} />
              ) : (
                <div className="answer-card">
                  {sections.length ? (
                    sections.map((section, idx) => (
                      <div className="answer-section" key={idx}>
                        {section.title && <h3>{section.title}</h3>}
                        {structuredByFormat(section.lines, section.lines)}
                      </div>
                    ))
                  ) : (
                    structuredByFormat(lines, paragraphs)
                  )}
                </div>
              )}
            </div>
            <h2>Trace</h2>
            <pre>{JSON.stringify(trace, null, 2)}</pre>
          </div>
        );
      }

      function App() {
        const [screen, setScreen] = React.useState(1);
        const [loading, setLoading] = React.useState(false);
        const [error, setError] = React.useState("");
        const [requestId, setRequestId] = React.useState(null);
        const [facets, setFacets] = React.useState([]);
        const [currentIndex, setCurrentIndex] = React.useState(0);
        const [answer, setAnswer] = React.useState("");
        const [answerMode, setAnswerMode] = React.useState("structured");
        const [trace, setTrace] = React.useState([]);

        const [query, setQuery] = React.useState("");
        const [domainHint, setDomainHint] = React.useState("");
        const [baseSelections, setBaseSelections] = React.useState({
          audience: "",
          format: "",
          length: "",
        });

        const [facetSelections, setFacetSelections] = React.useState({});

        const totalFacets = facets.length;
        const currentFacet = facets[currentIndex];

        function updateBaseSelection(key, value) {
          setBaseSelections((prev) => ({ ...prev, [key]: value }));
        }

        function updateFacetSelection(facetId, value, checked) {
          setFacetSelections((prev) => {
            const current = prev[facetId] || { values: new Set(), custom: "" };
            const nextValues = new Set(current.values);
            if (checked) {
              nextValues.add(value);
            } else {
              nextValues.delete(value);
            }
            return { ...prev, [facetId]: { ...current, values: nextValues } };
          });
        }

        function updateFacetCustom(facetId, customValue) {
          setFacetSelections((prev) => {
            const current = prev[facetId] || { values: new Set(), custom: "" };
            return { ...prev, [facetId]: { ...current, custom: customValue } };
          });
        }

        function selectionsForApi() {
          const selections = [];
          Object.entries(baseSelections).forEach(([id, value]) => {
            if (value) selections.push({ id, value });
          });

          Object.entries(facetSelections).forEach(([id, data]) => {
            const values = Array.from(data.values || []);
            if (data.custom) values.push(data.custom);
            const value = values.length ? values.join(", ") : null;
            if (value) selections.push({ id, value });
          });

          return selections;
        }

        async function handleDiscover() {
          setError("");
          setAnswer("");
          setTrace([]);
          if (!query.trim()) {
            setError("Please enter a query.");
            return;
          }
          setLoading(true);
          try {
            const res = await fetch(`${API_BASE}/api/discover`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                raw_query: query.trim(),
                domain_hint: domainHint.trim() || null,
              }),
            });
            const text = await res.text();
            if (!res.ok) {
              setError(text || "Discover failed.");
              return;
            }
            const data = JSON.parse(text);
            setRequestId(data.request_id);
            setFacets(data.facet_candidates || []);
            setCurrentIndex(0);
            setScreen(2);
          } catch (err) {
            setError("Discover failed.");
          } finally {
            setLoading(false);
          }
        }

        async function handleRefine() {
          if (!requestId) {
            setError("Please discover facets first.");
            return;
          }
          setLoading(true);
          setError("");
          try {
            const res = await fetch(`${API_BASE}/api/refine`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                request_id: requestId,
                facet_selections: selectionsForApi(),
                refine_round: 2,
              }),
            });
            const text = await res.text();
            if (!res.ok) {
              setError(text || "Refine failed.");
              return;
            }
            const data = JSON.parse(text);
            const nextFacets = data.facet_candidates || [];
            if (nextFacets.length) {
              setFacets((prev) => prev.concat(nextFacets));
              setCurrentIndex((prevIndex) => {
                const firstNewIndex = facets.length;
                return Math.max(firstNewIndex, prevIndex);
              });
            }
          } catch (err) {
            setError("Refine failed.");
          } finally {
            setLoading(false);
          }
        }

        async function handleAnswer() {
          if (!requestId) {
            setError("Please discover facets first.");
            return;
          }
          setLoading(true);
          setError("");
          try {
            const res = await fetch(`${API_BASE}/api/answer`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                request_id: requestId,
                facet_selections: selectionsForApi(),
              }),
            });
            const text = await res.text();
            if (!res.ok) {
              setError(text || "Answer failed.");
              return;
            }
            const data = JSON.parse(text);
            setAnswer(data.answer || "");
            setTrace(data.trace || []);
            setScreen(3);
          } catch (err) {
            setError("Answer failed.");
          } finally {
            setLoading(false);
          }
        }

        return (
          <div className="container">
            {screen === 1 && (
              <Screen1
                query={query}
                setQuery={setQuery}
                baseSelections={baseSelections}
                updateBaseSelection={updateBaseSelection}
                domainHint={domainHint}
                setDomainHint={setDomainHint}
                handleDiscover={handleDiscover}
                loading={loading}
                error={error}
              />
            )}
            {screen === 2 && (
              <Screen2
                totalFacets={totalFacets}
                currentIndex={currentIndex}
                setCurrentIndex={setCurrentIndex}
                currentFacet={currentFacet}
                requestId={requestId}
                handleRefine={handleRefine}
                handleAnswer={handleAnswer}
                loading={loading}
                error={error}
                facetSelections={facetSelections}
                updateFacetSelection={updateFacetSelection}
                updateFacetCustom={updateFacetCustom}
                selectionsForApi={selectionsForApi}
              />
            )}
            {screen === 3 && (
              <Screen3
                answer={answer}
                trace={trace}
                setScreen={setScreen}
                answerMode={answerMode}
                setAnswerMode={setAnswerMode}
                baseSelections={baseSelections}
              />
            )}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
