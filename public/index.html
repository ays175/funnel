<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&display=swap" rel="stylesheet"/>
    <title>ShmilBlick</title>
    <style>
      :root {
        /* Enhanced color palette */
        --bg: hsl(260, 45%, 5%);
        --bg-elevated: hsl(260, 40%, 8%);
        --text: hsl(240, 20%, 98%);
        --text-muted: hsl(240, 10%, 70%);
        --text-subtle: hsl(240, 8%, 55%);
        --border: hsla(260, 40%, 80%, 0.08);
        --border-strong: hsla(260, 40%, 80%, 0.15);
        
        /* Purple gradient system */
        --primary-50: hsl(270, 100%, 98%);
        --primary-500: hsl(270, 91%, 65%);
        --primary-600: hsl(271, 81%, 56%);
        --primary-700: hsl(272, 71%, 47%);
        
        /* Accent */
        --accent-pink: hsl(330, 81%, 60%);
        --accent-cyan: hsl(190, 90%, 60%);
        
        /* Bot colors */
        --bot-bg: hsla(260, 40%, 95%, 0.06);
        --user-bg: linear-gradient(135deg, var(--primary-600) 0%, var(--accent-pink) 100%);
        
        /* Surfaces */
        --surface-glass: hsla(260, 40%, 95%, 0.04);
        --surface-glass-hover: hsla(260, 40%, 95%, 0.06);
        
        /* Shadows */
        --shadow-sm: 0 2px 8px hsla(260, 50%, 10%, 0.3);
        --shadow-md: 0 4px 16px hsla(260, 50%, 10%, 0.4), 0 2px 4px hsla(260, 50%, 5%, 0.2);
        --shadow-lg: 0 12px 32px hsla(260, 50%, 10%, 0.5), 0 4px 8px hsla(260, 50%, 5%, 0.3);
        --shadow-purple: 0 8px 24px hsla(270, 91%, 50%, 0.35);
        
        /* Spacing scale */
        --space-1: 4px;
        --space-2: 8px;
        --space-3: 12px;
        --space-4: 16px;
        --space-5: 24px;
        --space-6: 32px;
        --space-8: 48px;
        --space-10: 64px;
        
        /* Radius */
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --radius-xl: 20px;
        --radius-full: 9999px;
        
        /* Transitions */
        --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      * { 
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        margin: 0;
        font-family: "Sora", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-size: 15px;
        line-height: 1.6;
        color: var(--text);
        background: radial-gradient(ellipse 1200px 800px at 30% 0%, hsl(270, 60%, 15%) 0%, hsl(260, 50%, 8%) 50%, var(--bg) 100%);
        min-height: 100vh;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .chat-container {
        max-width: 800px;
        margin: 0 auto;
        padding: var(--space-4);
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      /* Header */
      .chat-header {
        text-align: center;
        padding: var(--space-4) 0;
        border-bottom: 1px solid var(--border);
      }

      .chat-header h1 {
        font-size: clamp(24px, 4vw, 32px);
        margin: 0 0 var(--space-2);
        font-weight: 700;
        letter-spacing: -0.02em;
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--accent-pink) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .chat-header .tagline {
        font-size: 14px;
        color: var(--text-muted);
        font-weight: 500;
      }

      /* Messages */
      .messages-wrapper {
        flex: 1;
        overflow-y: auto;
        padding: var(--space-5) 0;
        display: flex;
        flex-direction: column;
        gap: var(--space-4);
      }

      .message {
        display: flex;
        gap: var(--space-3);
        align-items: flex-start;
        animation: slideIn var(--transition-base) ease-out;
      }

      @keyframes slideIn {
        from { opacity: 0; transform: translateY(12px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .message.user {
        flex-direction: row-reverse;
      }

      .message-avatar {
        flex-shrink: 0;
        width: 36px;
        height: 36px;
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 16px;
      }

      .message.bot .message-avatar {
        background: linear-gradient(135deg, var(--primary-600) 0%, var(--accent-pink) 100%);
        color: white;
        box-shadow: var(--shadow-purple);
      }

      .message.user .message-avatar {
        background: var(--surface-glass);
        border: 1px solid var(--border-strong);
        color: var(--text);
      }

      .message-bubble {
        max-width: 85%;
        padding: var(--space-4);
        border-radius: var(--radius-lg);
        line-height: 1.6;
        font-size: 16px;
      }

      .message.bot .message-bubble {
        background: var(--bot-bg);
        backdrop-filter: blur(12px);
        border: 1px solid var(--border);
      }

      .message.user .message-bubble {
        background: var(--user-bg);
        color: white;
        box-shadow: var(--shadow-purple);
      }

      .message-bubble strong {
        display: block;
        margin-bottom: var(--space-2);
        font-size: 16px;
        color: var(--primary-50);
      }

      .message.user .message-bubble strong {
        color: white;
      }

      /* Interactive selection message */
      .selection-message {
        background: var(--bot-bg);
        backdrop-filter: blur(12px);
        border: 1px solid var(--border-strong);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        margin: var(--space-2) 0;
        max-width: 100%;
      }

      .angle-header {
        display: inline-block;
        padding: var(--space-2) var(--space-4);
        background: linear-gradient(135deg, hsl(200, 70%, 50%) 0%, hsl(210, 75%, 55%) 100%);
        color: white;
        border-radius: var(--radius-full);
        font-size: 14px;
        font-weight: 700;
        margin-bottom: var(--space-3);
        box-shadow: 0 4px 12px hsla(200, 70%, 50%, 0.4);
      }

      .selection-question {
        font-size: 18px;
        font-weight: 600;
        margin: var(--space-3) 0;
        color: var(--text);
      }

      .selection-reason {
        font-size: 14px;
        color: var(--text-muted);
        margin-bottom: var(--space-4);
        line-height: 1.5;
      }

      /* Chips */
      .choice-chips {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
        margin: var(--space-4) 0;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        padding: var(--space-2) var(--space-4);
        border: 1px solid var(--border);
        border-radius: var(--radius-full);
        background: var(--surface-glass);
        backdrop-filter: blur(8px);
        font-size: 14px;
        font-weight: 500;
        color: var(--text);
        cursor: pointer;
        transition: all var(--transition-fast);
        user-select: none;
        white-space: nowrap;
      }

      .chip:hover {
        transform: translateY(-2px) scale(1.02);
        border-color: var(--border-strong);
        background: var(--surface-glass-hover);
        box-shadow: var(--shadow-sm);
      }

      .chip:active {
        transform: translateY(0) scale(0.98);
      }

      .chip.active {
        background: linear-gradient(135deg, var(--primary-600) 0%, var(--accent-pink) 100%);
        border-color: transparent;
        color: white;
        font-weight: 600;
        box-shadow: var(--shadow-purple);
      }

      .chip.active:hover {
        transform: translateY(-2px) scale(1.02);
        filter: brightness(1.1);
      }

      .subchoices-wrapper {
        margin-left: var(--space-5);
        margin-top: var(--space-2);
      }

      /* Action buttons in selection */
      .selection-actions {
        display: flex;
        gap: var(--space-3);
        margin-top: var(--space-4);
        flex-wrap: wrap;
      }

      /* Input bar */
      .input-bar {
        padding: var(--space-4);
        border-top: 1px solid var(--border-strong);
        background: hsla(260, 45%, 6%, 0.95);
        backdrop-filter: blur(16px);
      }

      .input-wrapper {
        display: flex;
        gap: var(--space-3);
        align-items: flex-end;
      }

      textarea {
        flex: 1;
        padding: var(--space-3) var(--space-4);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 15px;
        font-family: inherit;
        transition: border-color var(--transition-fast), background var(--transition-fast);
        resize: none;
        min-height: 48px;
        max-height: 120px;
        background: white;
        color: hsl(260, 45%, 10%);
      }

      textarea::placeholder {
        color: hsl(260, 10%, 50%);
      }

      textarea:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px hsla(270, 91%, 65%, 0.15);
      }

      /* Buttons */
      button {
        padding: var(--space-3) var(--space-5);
        border: 1px solid var(--border-strong);
        border-radius: var(--radius-md);
        background: var(--surface-glass);
        backdrop-filter: blur(8px);
        cursor: pointer;
        font-size: 15px;
        font-weight: 600;
        font-family: inherit;
        color: var(--text);
        transition: all var(--transition-fast);
        white-space: nowrap;
      }

      button:hover:not(:disabled) {
        transform: translateY(-1px);
        background: var(--surface-glass-hover);
        border-color: var(--primary-500);
        box-shadow: var(--shadow-sm);
      }

      button:active:not(:disabled) {
        transform: translateY(0);
      }

      button.primary {
        background: linear-gradient(135deg, var(--primary-600) 0%, var(--accent-pink) 100%);
        color: white;
        border: none;
        box-shadow: var(--shadow-purple);
      }

      button.primary:hover:not(:disabled) {
        transform: translateY(-2px);
        filter: brightness(1.1);
        box-shadow: 0 12px 32px hsla(270, 91%, 50%, 0.45);
      }

      button.orange {
        background: linear-gradient(135deg, hsl(25, 95%, 53%) 0%, hsl(15, 100%, 55%) 100%);
        color: white;
        border: none;
        box-shadow: 0 8px 24px hsla(25, 95%, 50%, 0.5);
        font-weight: 700;
      }

      button.orange:hover:not(:disabled) {
        transform: translateY(-2px) scale(1.02);
        filter: brightness(1.15);
        box-shadow: 0 12px 32px hsla(25, 95%, 50%, 0.6);
      }

      button.secondary {
        background: linear-gradient(135deg, hsl(200, 70%, 50%) 0%, hsl(210, 75%, 55%) 100%);
        color: white;
        border: none;
        box-shadow: 0 6px 18px hsla(200, 70%, 50%, 0.35);
        font-weight: 600;
      }

      button.secondary:hover:not(:disabled) {
        transform: translateY(-1px);
        filter: brightness(1.1);
        box-shadow: 0 8px 22px hsla(200, 70%, 50%, 0.45);
      }

      button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        transform: none !important;
      }

      /* Summary */
      .summary-card {
        background: var(--surface-glass);
        backdrop-filter: blur(12px);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        margin: var(--space-3) 0;
      }

      .summary-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-muted);
        margin-bottom: var(--space-3);
      }

      .summary-item {
        display: flex;
        gap: var(--space-2);
        margin-bottom: var(--space-2);
        align-items: flex-start;
      }

      .summary-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--primary-500);
        min-width: 100px;
      }

      .summary-value {
        font-size: 13px;
        color: var(--text);
        flex: 1;
      }

      /* Typing indicator */
      .typing-indicator {
        display: flex;
        gap: 6px;
        padding: var(--space-3);
      }

      .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--primary-500);
        animation: typing 1.4s infinite;
      }

      .typing-dot:nth-child(2) { animation-delay: 0.2s; }
      .typing-dot:nth-child(3) { animation-delay: 0.4s; }

      @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
        30% { transform: translateY(-10px); opacity: 1; }
      }

      /* Answer */
      .answer-content {
        background: var(--surface-glass);
        backdrop-filter: blur(12px);
        border: 1px solid var(--border-strong);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        margin: var(--space-3) 0;
        line-height: 1.7;
      }

      .markdown h1, .markdown h2, .markdown h3 {
        margin: var(--space-4) 0 var(--space-3);
        color: var(--text);
      }

      .markdown p { 
        margin: var(--space-3) 0;
        line-height: 1.7;
      }

      .markdown ul, .markdown ol { 
        margin: var(--space-3) 0 var(--space-3) var(--space-6);
        line-height: 1.7;
      }

      .markdown li {
        margin-bottom: var(--space-2);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .chat-container {
          padding: var(--space-3);
        }

        .message-bubble {
          max-width: 90%;
        }

        .selection-actions {
          flex-direction: column;
        }

        button {
          width: 100%;
        }

        .input-wrapper {
          flex-direction: column;
        }

        textarea {
          width: 100%;
        }
      }

      /* Scrollbar */
      .messages-wrapper::-webkit-scrollbar {
        width: 8px;
      }

      .messages-wrapper::-webkit-scrollbar-track {
        background: transparent;
      }

      .messages-wrapper::-webkit-scrollbar-thumb {
        background: var(--border-strong);
        border-radius: var(--radius-full);
      }

      .messages-wrapper::-webkit-scrollbar-thumb:hover {
        background: var(--primary-500);
      }

      /* Accessibility */
      *:focus-visible {
        outline: 2px solid var(--primary-500);
        outline-offset: 2px;
      }

      /* Loading state */
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }

      button:disabled {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const API_BASE = "https://funnel-production-859a.up.railway.app";

      function titleCase(value) {
        return String(value)
          .replace(/_/g, " ")
          .split(" ")
          .filter(Boolean)
          .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
          .join(" ");
      }

      function BotMessage({ children }) {
        return (
          <div className="message bot">
            <div className="message-avatar">ðŸ¤–</div>
            <div className="message-bubble">{children}</div>
          </div>
        );
      }

      function UserMessage({ children }) {
        return (
          <div className="message user">
            <div className="message-avatar">ðŸ‘¤</div>
            <div className="message-bubble">{children}</div>
          </div>
        );
      }

      function TypingIndicator() {
        return (
          <div className="message bot">
            <div className="message-avatar">ðŸ¤–</div>
            <div className="message-bubble">
              <div className="typing-indicator">
                <div className="typing-dot"></div>
                <div className="typing-dot"></div>
                <div className="typing-dot"></div>
              </div>
            </div>
          </div>
        );
      }

      function SelectionMessage({ facet, index, total, selections, onSelect, onNext, onSkip, onPickMore, onGetAnswer, isLastAngle, hasSelections }) {
        const [localSelections, setLocalSelections] = React.useState(new Set());

        React.useEffect(() => {
          setLocalSelections(new Set(selections[facet.id] || []));
        }, [facet.id, selections]);

        const toggleSelection = (value) => {
          const newSet = new Set(localSelections);
          if (value === "all options") {
            newSet.clear();
            newSet.add(value);
          } else {
            newSet.delete("all options");
            if (newSet.has(value)) {
              newSet.delete(value);
            } else {
              newSet.add(value);
            }
          }
          setLocalSelections(newSet);
          onSelect(facet.id, Array.from(newSet));
        };

        const choices = Array.isArray(facet.choices) ? facet.choices : 
          (facet.suggested_values || []).map((v) => ({ value: v, subchoices: [] }));

        return (
          <div className="selection-message">
            <div className="angle-header">Angle {index + 1}/{total}</div>
            <div className="selection-question">{facet.title}</div>
            {facet.question && <div className="selection-reason">{facet.question}</div>}
            {facet.reason && <div className="selection-reason">{facet.reason}</div>}
            
            <div className="choice-chips">
              {choices.map((choice) => {
                const isActive = localSelections.has(choice.value);
                return (
                  <div key={choice.value}>
                    <span
                      className={`chip ${isActive ? "active" : ""}`}
                      onClick={() => toggleSelection(choice.value)}
                    >
                      {titleCase(choice.value)}
                    </span>
                    {choice.subchoices && choice.subchoices.length > 0 && isActive && (
                      <div className="subchoices-wrapper">
                        {choice.subchoices.map((sub) => {
                          const subValue = `${choice.value} > ${sub}`;
                          const subActive = localSelections.has(subValue);
                          return (
                            <span
                              className={`chip ${subActive ? "active" : ""}`}
                              key={sub}
                              onClick={() => toggleSelection(subValue)}
                            >
                              {titleCase(sub)}
                            </span>
                          );
                        })}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>

            <div className="selection-actions">
              <button onClick={onSkip}>Skip</button>
              {!isLastAngle && <button className="primary" onClick={onNext}>Next â†’</button>}
              {isLastAngle && (
                <>
                  <button className="orange" onClick={onPickMore}>Pick More Angles</button>
                  <button className="primary" onClick={onGetAnswer}>Get Answer</button>
                </>
              )}
            </div>
          </div>
        );
      }

      function SummaryMessage({ selections, facets, baseSelections }) {
        const allSelections = [];
        
        if (baseSelections.audience) {
          allSelections.push({ label: "Audience", value: baseSelections.audience });
        }
        if (baseSelections.format) {
          allSelections.push({ label: "Format", value: baseSelections.format });
        }
        if (baseSelections.length) {
          allSelections.push({ label: "Length", value: baseSelections.length });
        }

        Object.entries(selections).forEach(([id, values]) => {
          if (values.length > 0) {
            const facet = facets.find(f => f.id === id);
            const label = facet ? facet.title : id;
            allSelections.push({ label, value: values.join(", ") });
          }
        });

        if (allSelections.length === 0) return null;

        return (
          <div className="summary-card">
            <div className="summary-title">Your Selections:</div>
            {allSelections.map((item, i) => (
              <div key={i} className="summary-item">
                <div className="summary-label">{item.label}:</div>
                <div className="summary-value">{titleCase(item.value)}</div>
              </div>
            ))}
          </div>
        );
      }

      function AnswerMessage({ answer }) {
        const [displayedText, setDisplayedText] = React.useState("");
        const [isComplete, setIsComplete] = React.useState(false);

        React.useEffect(() => {
          // Split answer into words for smooth streaming
          const words = answer.split(" ");
          let currentIndex = 0;

          const intervalId = setInterval(() => {
            if (currentIndex < words.length) {
              setDisplayedText((prev) => {
                const newText = prev + (prev ? " " : "") + words[currentIndex];
                return newText;
              });
              currentIndex++;
            } else {
              clearInterval(intervalId);
              setIsComplete(true);
            }
          }, 50); // 50ms per word for smooth streaming

          return () => clearInterval(intervalId);
        }, [answer]);

        function escapeHtml(value) {
          return String(value)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        }

        function renderMarkdown(value) {
          const rawLines = String(value || "").split(/\n/);
          const htmlLines = [];
          let inList = false;
          let listType = "ul";

          const flushList = () => {
            if (inList) {
              htmlLines.push(listType === "ol" ? "</ol>" : "</ul>");
              inList = false;
            }
          };

          rawLines.forEach((raw) => {
            const line = raw.trim();
            if (!line) {
              flushList();
              return;
            }
            if (/^###\s+/.test(line)) {
              flushList();
              htmlLines.push(`<h3>${escapeHtml(line.replace(/^###\s+/, ""))}</h3>`);
              return;
            }
            if (/^##\s+/.test(line)) {
              flushList();
              htmlLines.push(`<h2>${escapeHtml(line.replace(/^##\s+/, ""))}</h2>`);
              return;
            }
            if (/^#\s+/.test(line)) {
              flushList();
              htmlLines.push(`<h1>${escapeHtml(line.replace(/^#\s+/, ""))}</h1>`);
              return;
            }
            if (/^\d+\.\s+/.test(line)) {
              if (!inList || listType !== "ol") {
                flushList();
                inList = true;
                listType = "ol";
                htmlLines.push("<ol>");
              }
              htmlLines.push(`<li>${escapeHtml(line.replace(/^\d+\.\s+/, ""))}</li>`);
              return;
            }
            if (/^[-*â€¢]\s+/.test(line)) {
              if (!inList || listType !== "ul") {
                flushList();
                inList = true;
                listType = "ul";
                htmlLines.push("<ul>");
              }
              htmlLines.push(`<li>${escapeHtml(line.replace(/^[-*â€¢]\s+/, ""))}</li>`);
              return;
            }

            flushList();
            let safe = escapeHtml(line);
            safe = safe.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
            safe = safe.replace(/\*(.+?)\*/g, "<em>$1</em>");
            htmlLines.push(`<p>${safe}</p>`);
          });

          flushList();
          return htmlLines.join("");
        }

        return (
          <div className="answer-content markdown" dangerouslySetInnerHTML={{ __html: renderMarkdown(displayedText) }} />
        );
      }

      function App() {
        const [messages, setMessages] = React.useState([]);
        const [conversationState, setConversationState] = React.useState("initial");
        const [query, setQuery] = React.useState("");
        const [domainHint, setDomainHint] = React.useState("");
        const [requestId, setRequestId] = React.useState(null);
        const [facets, setFacets] = React.useState([]);
        const [currentAngleIndex, setCurrentAngleIndex] = React.useState(0);
        const [selections, setSelections] = React.useState({});
        const [baseSelections, setBaseSelections] = React.useState({
          audience: "",
          format: "",
          length: ""
        });
        const [loading, setLoading] = React.useState(false);
        const [trace, setTrace] = React.useState([]);
        const [compiledPrompt, setCompiledPrompt] = React.useState(null);
        const [reasoningApproach, setReasoningApproach] = React.useState({
          tone: "",
          evidence_style: "",
          structure: "",
          custom_instructions: ""
        });
        const messagesEndRef = React.useRef(null);

        const scrollToBottom = () => {
          messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
        };

        React.useEffect(() => {
          // Scroll to bottom when new messages are added (except during answer streaming)
          const lastMessage = messages[messages.length - 1];
          if (lastMessage && lastMessage.content?.type !== "answer") {
            scrollToBottom();
          }
        }, [messages.length]); // Only trigger on message count change, not content change

        React.useEffect(() => {
          // Welcome message
          setMessages([
            { type: "bot", content: "Hi! I'm ShmilBlick, your AI assistant with a laser focus. ðŸŽ¯" },
            { type: "bot", content: "What would you like to know today?" }
          ]);
        }, []);

        const addMessage = (type, content) => {
          setMessages(prev => [...prev, { type, content }]);
        };

        const handleQuerySubmit = async () => {
          if (!query.trim()) return;

          addMessage("user", query);
          setConversationState("processing_query");
          setLoading(true);

          addMessage("bot", <TypingIndicator />);

          try {
            const res = await fetch(`${API_BASE}/api/discover`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                raw_query: query.trim(),
                domain_hint: domainHint.trim() || null,
              }),
            });

            if (!res.ok) {
              throw new Error("Failed to discover angles");
            }

            const data = await res.json();
            setRequestId(data.request_id);
            setFacets(data.facet_candidates || []);
            setCurrentAngleIndex(0);

            // Remove typing indicator
            setMessages(prev => prev.slice(0, -1));

            addMessage("bot", `Great question! I found ${data.facet_candidates.length} angles to explore. Let's go through them! ðŸŽ¯`);
            
            // Add base selections message
            addMessage("bot", "First, let me know your preferences:");
            addMessage("bot", { type: "base_selections" });

            setConversationState("gathering_base_selections");
          } catch (err) {
            setMessages(prev => prev.slice(0, -1));
            addMessage("bot", "Sorry, I encountered an error. Please try again.");
          } finally {
            setLoading(false);
            setQuery("");
            setDomainHint("");
          }
        };

        const handleBaseSelectionsConfirm = () => {
          if (!baseSelections.audience || !baseSelections.format || !baseSelections.length) {
            addMessage("bot", "Please select Audience, Format, and Length before continuing.");
            return;
          }

          addMessage("bot", "Perfect! Now let's explore the angles:");
          setConversationState("showing_angles");
          setCurrentAngleIndex(0);

          // Show first angle
          if (facets.length > 0) {
            addMessage("bot", { type: "selection", facetIndex: 0 });
          }
        };

        const handleSelection = (facetId, values) => {
          setSelections(prev => ({ ...prev, [facetId]: values }));
        };

        const handleNextAngle = () => {
          addMessage("bot", "Got it! âœ“");
          
          if (currentAngleIndex < facets.length - 1) {
            const nextIndex = currentAngleIndex + 1;
            setCurrentAngleIndex(nextIndex);
            addMessage("bot", { type: "selection", facetIndex: nextIndex });
          }
        };

        const handleSkipAngle = () => {
          addMessage("bot", "Skipped. Moving on...");
          
          if (currentAngleIndex < facets.length - 1) {
            const nextIndex = currentAngleIndex + 1;
            setCurrentAngleIndex(nextIndex);
            addMessage("bot", { type: "selection", facetIndex: nextIndex });
          } else {
            handleAllAnglesCompleted();
          }
        };

        const handleAllAnglesCompleted = () => {
          addMessage("bot", { type: "summary" });
          addMessage("bot", "All angles covered! Before generating your answer, would you like to customize the reasoning approach?");
          addMessage("bot", { type: "reasoning_options" });
          setConversationState("ready_to_answer");
        };

        const handlePickMoreAngles = async () => {
          if (!requestId) return;

          addMessage("bot", "Looking for more angles...");
          setLoading(true);
          addMessage("bot", <TypingIndicator />);

          try {
            const apiSelections = [];
            Object.entries(baseSelections).forEach(([id, value]) => {
              if (value) apiSelections.push({ id, value });
            });
            Object.entries(selections).forEach(([id, values]) => {
              if (values.length > 0) apiSelections.push({ id, value: values.join(", ") });
            });

            const res = await fetch(`${API_BASE}/api/refine`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                request_id: requestId,
                facet_selections: apiSelections,
                refine_round: 2,
              }),
            });

            if (!res.ok) {
              throw new Error("Failed to refine");
            }

            const data = await res.json();
            const newFacets = data.facet_candidates || [];

            setMessages(prev => prev.slice(0, -1));

            if (newFacets.length > 0) {
              const oldLength = facets.length;
              setFacets(prev => [...prev, ...newFacets]);
              addMessage("bot", `Found ${newFacets.length} more angles! Let's explore them:`);
              
              const nextIndex = oldLength;
              setCurrentAngleIndex(nextIndex);
              addMessage("bot", { type: "selection", facetIndex: nextIndex });
              setConversationState("showing_angles");
            } else {
              addMessage("bot", "No additional angles found. Ready to get your answer!");
            }
          } catch (err) {
            setMessages(prev => prev.slice(0, -1));
            addMessage("bot", "Sorry, I couldn't find more angles. Please try again.");
          } finally {
            setLoading(false);
          }
        };

        const handleGetAnswer = async () => {
          if (!requestId) return;

          addMessage("bot", "Generating your answer...");
          setLoading(true);
          addMessage("bot", <TypingIndicator />);

          try {
            const apiSelections = [];
            Object.entries(baseSelections).forEach(([id, value]) => {
              if (value) apiSelections.push({ id, value });
            });
            Object.entries(selections).forEach(([id, values]) => {
              if (values.length > 0) apiSelections.push({ id, value: values.join(", ") });
            });

            // Build user_overrides with reasoning approach
            const userOverrides = {};
            const instructionParts = [];
            
            if (reasoningApproach.tone) {
              instructionParts.push(`Tone: ${reasoningApproach.tone}`);
            }
            if (reasoningApproach.evidence_style) {
              instructionParts.push(`Evidence style: ${reasoningApproach.evidence_style}`);
            }
            if (reasoningApproach.structure) {
              instructionParts.push(`Structure: ${reasoningApproach.structure}`);
            }
            if (reasoningApproach.custom_instructions) {
              instructionParts.push(reasoningApproach.custom_instructions);
            }
            
            if (instructionParts.length > 0) {
              userOverrides.instructions = "Answer clearly and concisely. " + instructionParts.join(". ") + ".";
            }

            const res = await fetch(`${API_BASE}/api/answer`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                request_id: requestId,
                facet_selections: apiSelections,
                user_overrides: Object.keys(userOverrides).length > 0 ? userOverrides : null,
              }),
            });

            if (!res.ok) {
              throw new Error("Failed to get answer");
            }

            const data = await res.json();

            setMessages(prev => prev.slice(0, -1));
            
            // Add explainer showing how selections shaped the answer
            addMessage("bot", "âœ¨ How your selections shaped this answer:");
            addMessage("bot", { type: "selection_explainer" });
            
            addMessage("bot", "Here's your answer:");
            addMessage("bot", { type: "answer", answer: data.answer });
            setTrace(data.trace || []);
            setCompiledPrompt(data.compiled_prompt || null);
            addMessage("bot", "ðŸ’¡ Want to see the full reasoning? Check the prompt and trace for complete transparency!");
            addMessage("bot", { type: "post_answer_actions" });
            
            setConversationState("answer_shown");
          } catch (err) {
            setMessages(prev => prev.slice(0, -1));
            addMessage("bot", "Sorry, I couldn't generate an answer. Please try again.");
          } finally {
            setLoading(false);
          }
        };

        const handleNewQuery = () => {
          setMessages([
            { type: "bot", content: "Hi! I'm ShmilBlick, your AI assistant with a laser focus. ðŸŽ¯" },
            { type: "bot", content: "What would you like to know today?" }
          ]);
          setConversationState("initial");
          setQuery("");
          setDomainHint("");
          setRequestId(null);
          setFacets([]);
          setCurrentAngleIndex(0);
          setSelections({});
          setBaseSelections({ audience: "", format: "", length: "" });
        };

        const renderMessage = (msg, index) => {
          if (msg.type === "bot") {
            if (typeof msg.content === "string") {
              return <BotMessage key={index}>{msg.content}</BotMessage>;
            } else if (msg.content?.type === "base_selections") {
              return (
                <div key={index} className="selection-message">
                  <div className="selection-question">Select your preferences:</div>
                  <div>
                    <strong style={{display: 'block', marginBottom: 'var(--space-2)', marginTop: 'var(--space-3)'}}>Audience</strong>
                    <div className="choice-chips">
                      {["beginner", "intermediate", "expert", "executive"].map((v) => (
                        <span
                          className={`chip ${baseSelections.audience === v ? "active" : ""}`}
                          key={v}
                          onClick={() => setBaseSelections(prev => ({ ...prev, audience: v }))}
                        >
                          {titleCase(v)}
                        </span>
                      ))}
                    </div>
                  </div>
                  <div>
                    <strong style={{display: 'block', marginBottom: 'var(--space-2)', marginTop: 'var(--space-3)'}}>Format</strong>
                    <div className="choice-chips">
                      {["bullets", "steps", "table", "paragraphs"].map((v) => (
                        <span
                          className={`chip ${baseSelections.format === v ? "active" : ""}`}
                          key={v}
                          onClick={() => setBaseSelections(prev => ({ ...prev, format: v }))}
                        >
                          {titleCase(v)}
                        </span>
                      ))}
                    </div>
                  </div>
                  <div>
                    <strong style={{display: 'block', marginBottom: 'var(--space-2)', marginTop: 'var(--space-3)'}}>Length</strong>
                    <div className="choice-chips">
                      {["300 words", "600 words", "900 words", "1200 words"].map((v) => (
                        <span
                          className={`chip ${baseSelections.length === v ? "active" : ""}`}
                          key={v}
                          onClick={() => setBaseSelections(prev => ({ ...prev, length: v }))}
                        >
                          {titleCase(v)}
                        </span>
                      ))}
                    </div>
                  </div>
                  <div className="selection-actions">
                    <button className="primary" onClick={handleBaseSelectionsConfirm}>
                      Continue
                    </button>
                  </div>
                </div>
              );
            } else if (msg.content?.type === "selection") {
              const facet = facets[msg.content.facetIndex];
              if (!facet) return null;
              return (
                <SelectionMessage
                  key={index}
                  facet={facet}
                  index={msg.content.facetIndex}
                  total={facets.length}
                  selections={selections}
                  onSelect={handleSelection}
                  onNext={handleNextAngle}
                  onSkip={handleSkipAngle}
                  onPickMore={handlePickMoreAngles}
                  onGetAnswer={handleGetAnswer}
                  isLastAngle={msg.content.facetIndex === facets.length - 1}
                  hasSelections={Object.keys(selections).length > 0}
                />
              );
            } else if (msg.content?.type === "summary") {
              return <SummaryMessage key={index} selections={selections} facets={facets} baseSelections={baseSelections} />;
            } else if (msg.content?.type === "editable_summary") {
              // Editable summary with all selections displayed as chips
              return (
                <div key={index} className="selection-message">
                  <div className="summary-title" style={{marginBottom: 'var(--space-4)', fontSize: '16px', fontWeight: 600}}>
                    Your Current Selections - Click any to edit:
                  </div>

                  {/* Base Preferences */}
                  {(baseSelections.audience || baseSelections.format || baseSelections.length) && (
                    <div style={{marginBottom: 'var(--space-5)', padding: 'var(--space-4)', background: 'var(--surface-glass)', borderRadius: 'var(--radius-md)', border: '1px solid var(--border)'}}>
                      <div style={{
                        fontWeight: 600,
                        color: 'var(--primary-500)',
                        marginBottom: 'var(--space-3)',
                        fontSize: '15px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'space-between'
                      }}>
                        <span>Base Preferences</span>
                        <button
                          style={{
                            padding: '4px 12px',
                            fontSize: '12px',
                            background: 'var(--surface-glass-hover)',
                            border: '1px solid var(--border-strong)',
                            borderRadius: 'var(--radius-full)',
                            cursor: 'pointer',
                            color: 'var(--text)',
                            fontWeight: 600
                          }}
                          onClick={() => {
                            addMessage("bot", "Let's update your base preferences:");
                            addMessage("bot", { type: "base_selections" });
                            setConversationState("gathering_base_selections");
                          }}
                        >
                          Edit
                        </button>
                      </div>
                      <div style={{display: 'flex', flexWrap: 'wrap', gap: 'var(--space-2)'}}>
                        {baseSelections.audience && (
                          <span className="chip active">{titleCase(baseSelections.audience)}</span>
                        )}
                        {baseSelections.format && (
                          <span className="chip active">{titleCase(baseSelections.format)}</span>
                        )}
                        {baseSelections.length && (
                          <span className="chip active">{titleCase(baseSelections.length)}</span>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Angle Selections */}
                  {facets.map((facet, facetIndex) => {
                    const facetSelections = selections[facet.id];
                    if (!facetSelections || facetSelections.length === 0) return null;

                    // Parse selections to show parent/child hierarchy
                    const tree = {};
                    facetSelections.forEach((val) => {
                      if (val.includes(" > ")) {
                        const [parent, child] = val.split(" > ").map((v) => v.trim());
                        if (!tree[parent]) tree[parent] = { children: [] };
                        if (!tree[parent].children.includes(child)) tree[parent].children.push(child);
                      } else {
                        if (!tree[val]) tree[val] = { children: [] };
                      }
                    });

                    return (
                      <div key={facet.id} style={{marginBottom: 'var(--space-5)', padding: 'var(--space-4)', background: 'var(--surface-glass)', borderRadius: 'var(--radius-md)', border: '1px solid var(--border)'}}>
                        <div style={{
                          fontWeight: 600,
                          color: 'var(--primary-500)',
                          marginBottom: 'var(--space-3)',
                          fontSize: '15px',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'space-between'
                        }}>
                          <span>{facet.title}</span>
                          <button
                            style={{
                              padding: '4px 12px',
                              fontSize: '12px',
                              background: 'var(--surface-glass-hover)',
                              border: '1px solid var(--border-strong)',
                              borderRadius: 'var(--radius-full)',
                              cursor: 'pointer',
                              color: 'var(--text)',
                              fontWeight: 600
                            }}
                            onClick={() => {
                              setCurrentAngleIndex(facetIndex);
                              addMessage("bot", `Let's review ${facet.title}:`);
                              addMessage("bot", { type: "selection", facetIndex: facetIndex });
                              setConversationState("showing_angles");
                            }}
                          >
                            Edit
                          </button>
                        </div>
                        <div>
                          {Object.entries(tree).map(([parent, data]) => (
                            <div key={parent} style={{marginBottom: 'var(--space-2)'}}>
                              <span 
                                className="chip active" 
                                style={{cursor: 'pointer'}}
                                onClick={() => {
                                  setCurrentAngleIndex(facetIndex);
                                  addMessage("bot", `Let's review ${facet.title}:`);
                                  addMessage("bot", { type: "selection", facetIndex: facetIndex });
                                  setConversationState("showing_angles");
                                }}
                              >
                                {titleCase(parent)}
                              </span>
                              {data.children.length > 0 && (
                                <div style={{marginLeft: 'var(--space-5)', marginTop: 'var(--space-2)', display: 'flex', flexWrap: 'wrap', gap: 'var(--space-2)'}}>
                                  {data.children.map((child) => (
                                    <span 
                                      className="chip active" 
                                      key={child}
                                      style={{cursor: 'pointer'}}
                                      onClick={() => {
                                        setCurrentAngleIndex(facetIndex);
                                        addMessage("bot", `Let's review ${facet.title}:`);
                                        addMessage("bot", { type: "selection", facetIndex: facetIndex });
                                        setConversationState("showing_angles");
                                      }}
                                    >
                                      {titleCase(child)}
                                    </span>
                                  ))}
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      </div>
                    );
                  })}

                  <div className="selection-actions" style={{marginTop: 'var(--space-5)'}}>
                    <button className="orange" onClick={handlePickMoreAngles} disabled={loading}>
                      Pick More Angles
                    </button>
                    <button className="primary" onClick={handleGetAnswer} disabled={loading}>
                      Regenerate Answer
                    </button>
                  </div>
                </div>
              );
            } else if (msg.content?.type === "answer") {
              return <AnswerMessage key={index} answer={msg.content.answer} />;
            } else if (msg.content?.type === "compiled_prompt") {
              const prompt = msg.content.promptData;
              if (!prompt || !prompt.sections) {
                return (
                  <div key={index} className="answer-content">
                    <p>Prompt data not available.</p>
                  </div>
                );
              }

              return (
                <div key={index} className="answer-content" style={{padding: 0}}>
                  {prompt.sections.map((section, sIdx) => (
                    <div key={sIdx} style={{
                      marginBottom: sIdx < prompt.sections.length - 1 ? 'var(--space-4)' : 0,
                      padding: 'var(--space-4)',
                      background: sIdx % 2 === 0 ? 'var(--surface-glass)' : 'transparent',
                      borderRadius: 'var(--radius-md)',
                      border: '1px solid var(--border)'
                    }}>
                      <div style={{
                        fontWeight: 700,
                        fontSize: '13px',
                        color: 'var(--primary-500)',
                        textTransform: 'uppercase',
                        letterSpacing: '0.05em',
                        marginBottom: 'var(--space-2)'
                      }}>
                        {section.title}
                      </div>
                      <div style={{
                        fontSize: '14px',
                        color: 'var(--text)',
                        lineHeight: 1.7,
                        whiteSpace: 'pre-wrap',
                        fontFamily: section.title === 'Instructions' ? 'inherit' : 'monospace'
                      }}>
                        {section.content}
                      </div>
                    </div>
                  ))}
                </div>
              );
            } else if (msg.content?.type === "trace") {
              return (
                <div key={index} className="answer-content" style={{fontFamily: 'monospace', fontSize: '13px'}}>
                  <pre style={{whiteSpace: 'pre-wrap', margin: 0, lineHeight: 1.6}}>
                    {JSON.stringify(msg.content.traceData, null, 2)}
                  </pre>
                </div>
              );
            } else if (msg.content?.type === "selection_explainer") {
              // Explainer showing how selections shaped the answer
              const explainers = [];
              
              if (baseSelections.audience) {
                const audienceMap = {
                  beginner: "Using simple language and explaining foundational concepts",
                  intermediate: "Using moderate complexity, avoiding both oversimplification and jargon",
                  expert: "Using technical terminology and assuming advanced background knowledge",
                  executive: "Focusing on high-level insights and strategic implications"
                };
                explainers.push({
                  label: "Audience",
                  value: titleCase(baseSelections.audience),
                  impact: audienceMap[baseSelections.audience]
                });
              }
              
              if (baseSelections.format) {
                const formatMap = {
                  bullets: "Organizing information in clear, scannable bullet points",
                  steps: "Structuring content as a sequential, actionable process",
                  table: "Presenting data in a structured, comparative table format",
                  paragraphs: "Crafting flowing narrative with detailed explanations"
                };
                explainers.push({
                  label: "Format",
                  value: titleCase(baseSelections.format),
                  impact: formatMap[baseSelections.format]
                });
              }
              
              if (baseSelections.length) {
                explainers.push({
                  label: "Length",
                  value: titleCase(baseSelections.length),
                  impact: `Targeting approximately ${baseSelections.length} to balance depth and conciseness`
                });
              }

              // Add topic-specific angle impacts
              Object.entries(selections).forEach(([facetId, values]) => {
                if (values && values.length > 0) {
                  const facet = facets.find(f => f.id === facetId);
                  const facetTitle = facet ? facet.title : titleCase(facetId);
                  const valueStr = values.map(v => titleCase(v)).join(", ");
                  explainers.push({
                    label: facetTitle,
                    value: valueStr,
                    impact: `Emphasizing these aspects while filtering out less relevant information`
                  });
                }
              });

              return (
                <div key={index} className="summary-card">
                  {explainers.map((item, i) => (
                    <div key={i} style={{marginBottom: 'var(--space-3)'}}>
                      <div style={{fontWeight: 600, fontSize: '14px', color: 'var(--primary-500)', marginBottom: 'var(--space-1)'}}>
                        â€¢ {item.label} ({item.value})
                      </div>
                      <div style={{fontSize: '14px', color: 'var(--text-muted)', paddingLeft: 'var(--space-4)'}}>
                        {item.impact}
                      </div>
                    </div>
                  ))}
                </div>
              );
            } else if (msg.content?.type === "post_answer_actions") {
              return (
                <div key={index} className="selection-message">
                  <div className="selection-question">What would you like to do?</div>
                  
                  <div style={{marginBottom: 'var(--space-4)'}}>
                    <div style={{fontWeight: 600, marginBottom: 'var(--space-2)', fontSize: '14px'}}>
                      View Prompt
                    </div>
                    <div className="selection-reason" style={{marginBottom: 'var(--space-3)'}}>
                      See the exact instructions sent to the AI, including how your angle selections shaped the query.
                    </div>
                    <div className="selection-actions">
                      <button className="secondary" onClick={() => {
                        addMessage("bot", "Here's the exact prompt sent to the AI:");
                        addMessage("bot", { type: "compiled_prompt", promptData: compiledPrompt });
                      }}>
                        View Prompt ðŸ“
                      </button>
                    </div>
                  </div>

                  <div style={{borderTop: '1px solid var(--border)', margin: 'var(--space-4) 0', paddingTop: 'var(--space-4)'}}>
                    <div style={{fontWeight: 600, marginBottom: 'var(--space-2)', fontSize: '14px'}}>
                      View Trace
                    </div>
                    <div className="selection-reason" style={{marginBottom: 'var(--space-3)'}}>
                      See the complete reasoning trail and decisions I made to generate this answer.
                    </div>
                    <div className="selection-actions">
                      <button className="secondary" onClick={() => {
                        addMessage("bot", "Here's the complete trace of how I processed your query:");
                        addMessage("bot", { type: "trace", traceData: trace });
                      }}>
                        View Trace ðŸ”µ
                      </button>
                    </div>
                  </div>

                  <div style={{borderTop: '1px solid var(--border)', margin: 'var(--space-4) 0', paddingTop: 'var(--space-4)'}}>
                    <div style={{fontWeight: 600, marginBottom: 'var(--space-2)', fontSize: '14px'}}>
                      Refine Answer
                    </div>
                    <div className="selection-reason" style={{marginBottom: 'var(--space-3)'}}>
                      Review and modify your angle selections, or pick more angles for even more precision.
                    </div>
                    <div className="selection-actions">
                      <button className="orange" onClick={() => {
                        addMessage("bot", "Here are your current selections. Click any angle to modify it:");
                        addMessage("bot", { type: "editable_summary" });
                        setConversationState("editing_angles");
                      }}>
                        Refine Angles
                      </button>
                    </div>
                  </div>

                  <div style={{borderTop: '1px solid var(--border)', margin: 'var(--space-4) 0', paddingTop: 'var(--space-4)'}}>
                    <div style={{fontWeight: 600, marginBottom: 'var(--space-2)', fontSize: '14px'}}>
                      Start Fresh
                    </div>
                    <div className="selection-reason" style={{marginBottom: 'var(--space-3)'}}>
                      Ask a new question and explore different angles.
                    </div>
                    <div className="selection-actions">
                      <button className="primary" onClick={handleNewQuery}>
                        New Query
                      </button>
                    </div>
                  </div>
                </div>
              );
            } else {
              return <BotMessage key={index}>{msg.content}</BotMessage>;
            }
          } else if (msg.type === "user") {
            return <UserMessage key={index}>{msg.content}</UserMessage>;
          }
          return null;
        };

        return (
          <div className="chat-container">
            <div className="chat-header">
              <h1>ShmilBlick</h1>
              <div className="tagline">Ask once, get exactly what you need. AI with a laser focus.</div>
            </div>

            <div className="messages-wrapper">
              {messages.map((msg, i) => renderMessage(msg, i))}
              <div ref={messagesEndRef} />
            </div>

            <div className="input-bar">
              {conversationState === "initial" || conversationState === "answer_shown" ? (
                <div className="input-wrapper">
                  <textarea
                    value={query}
                    onChange={(e) => setQuery(e.target.value)}
                    placeholder="Ask anything..."
                    onKeyDown={(e) => {
                      if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        handleQuerySubmit();
                      }
                    }}
                  />
                  <button className="primary" onClick={handleQuerySubmit} disabled={loading || !query.trim()}>
                    Send
                  </button>
                </div>
              ) : conversationState === "ready_to_answer" ? (
                <div className="input-wrapper">
                  <button className="orange" onClick={handlePickMoreAngles} disabled={loading}>
                    Pick More Angles
                  </button>
                  <button className="primary" onClick={handleGetAnswer} disabled={loading}>
                    Get Answer
                  </button>
                  <button className="secondary" onClick={handleNewQuery}>
                    New Query
                  </button>
                </div>
              ) : (
                <div className="input-wrapper">
                  <button className="secondary" onClick={handleNewQuery}>
                    New Query
                  </button>
                </div>
              )}
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
