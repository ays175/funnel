<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%238b5cf6;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23ec4899;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' fill='url(%23grad)' rx='15'/%3E%3Ctext x='50' y='72' font-family='Arial,sans-serif' font-size='60' font-weight='700' fill='white' text-anchor='middle'%3ES%3C/text%3E%3C/svg%3E" type="image/svg+xml"/>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&display=swap" rel="stylesheet"/>
    <title>Legal</title>
    <style>
      :root {
        /* Enhanced color palette */
        --bg: hsl(260, 30%, 7%);
        --bg-elevated: hsl(260, 28%, 10%);
        --text: hsl(240, 20%, 98%);
        --text-muted: hsl(240, 10%, 72%);
        --text-subtle: hsl(240, 8%, 58%);
        --border: hsla(260, 25%, 70%, 0.15);
        --border-strong: hsla(260, 25%, 70%, 0.25);
        
        /* Purple gradient system */
        --primary-50: hsl(270, 100%, 98%);
        --primary-500: hsl(270, 91%, 65%);
        --primary-600: hsl(271, 81%, 56%);
        --primary-700: hsl(272, 71%, 47%);
        
        /* Accent */
        --accent-pink: hsl(330, 81%, 60%);
        --accent-cyan: hsl(190, 90%, 60%);
        
        /* Bot colors */
        --bot-bg: hsla(260, 30%, 16%, 0.65);
        --user-bg: hsl(270, 70%, 50%);
        
        /* Surfaces */
        --surface-glass: hsla(260, 30%, 16%, 0.8);
        --surface-glass-hover: hsla(260, 30%, 18%, 0.9);
        
        /* Shadows */
        --shadow-sm: 0 1px 4px hsla(260, 35%, 10%, 0.25);
        --shadow-md: 0 4px 12px hsla(260, 35%, 10%, 0.28);
        --shadow-lg: 0 10px 24px hsla(260, 35%, 10%, 0.32);
        --shadow-purple: 0 6px 18px hsla(270, 60%, 40%, 0.25);
        
        /* Spacing scale */
        --space-1: 4px;
        --space-2: 8px;
        --space-3: 12px;
        --space-4: 16px;
        --space-5: 24px;
        --space-6: 32px;
        --space-8: 48px;
        --space-10: 64px;
        
        /* Radius */
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --radius-xl: 20px;
        --radius-full: 9999px;
        
        /* Transitions */
        --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      * { 
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        margin: 0;
        font-family: "Sora", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-size: 15px;
        line-height: 1.6;
        color: var(--text);
        background: linear-gradient(180deg, hsl(260, 35%, 11%) 0%, var(--bg) 100%);
        min-height: 100vh;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .chat-container {
        max-width: 800px;
        margin: 0 auto;
        padding: var(--space-4);
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      /* Header */
      .chat-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-2) var(--space-4);
        border-bottom: 1px solid var(--border);
        gap: var(--space-4);
      }

      .header-content {
        text-align: center;
        flex: 1;
      }

      .chat-header h1 {
        font-size: clamp(24px, 3.5vw, 34px);
        margin: 4px 0 0 0;
        font-weight: 700;
        letter-spacing: -0.01em;
        color: var(--primary-500);
        cursor: pointer;
        transition: color var(--transition-fast);
        user-select: none;
      }

      .chat-header h1:hover {
        color: var(--primary-50);
      }

      .chat-header .tagline {
        font-size: 14px;
        color: var(--text-muted);
        font-weight: 500;
        margin-top: -4px;
      }

      .header-new-query-btn {
        padding: var(--space-2) var(--space-4);
        border: 1px solid var(--border-strong);
        border-radius: var(--radius-md);
        background: var(--primary-600);
        color: white;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-fast);
        white-space: nowrap;
        box-shadow: var(--shadow-sm);
        flex-shrink: 0;
      }

      .header-new-query-btn:hover {
        filter: brightness(1.05);
        box-shadow: var(--shadow-md);
      }

      .header-new-query-btn:active {
        transform: translateY(0);
      }

      /* Messages */
      .messages-wrapper {
        flex: 1;
        overflow-y: auto;
        padding: var(--space-5) 0;
        display: flex;
        flex-direction: column;
        gap: var(--space-4);
      }

      .message {
        display: flex;
        gap: var(--space-3);
        align-items: flex-start;
        animation: slideIn var(--transition-base) ease-out;
      }

      @keyframes slideIn {
        from { opacity: 0; transform: translateY(12px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .message.user {
        flex-direction: row-reverse;
      }

      .message-avatar {
        flex-shrink: 0;
        width: 36px;
        height: 36px;
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 16px;
      }

      .message.bot .message-avatar {
        background: var(--primary-600);
        color: white;
        box-shadow: var(--shadow-sm);
      }

      .message.user .message-avatar {
        background: var(--surface-glass);
        border: 1px solid var(--border-strong);
        color: var(--text);
      }

      .message-bubble {
        max-width: 85%;
        padding: var(--space-4);
        border-radius: var(--radius-lg);
        line-height: 1.6;
        font-size: 16px;
      }

      .message.bot .message-bubble {
        background: var(--bot-bg);
        backdrop-filter: blur(12px);
        border: 1px solid var(--border);
      }

      .message.user .message-bubble {
        background: var(--user-bg);
        color: white;
        box-shadow: var(--shadow-sm);
      }

      .message-bubble strong {
        display: block;
        margin-bottom: var(--space-2);
        font-size: 16px;
        color: var(--primary-50);
      }

      .message.user .message-bubble strong {
        color: white;
      }

      /* Interactive selection message */
      .selection-message {
        background: var(--bot-bg);
        backdrop-filter: blur(12px);
        border: 1px solid var(--border-strong);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        margin: var(--space-2) 0;
        max-width: 100%;
      }

      .angle-header {
        display: inline-block;
        padding: var(--space-2) var(--space-4);
        background: hsl(210, 70%, 45%);
        color: white;
        border-radius: var(--radius-full);
        font-size: 14px;
        font-weight: 700;
        margin-bottom: var(--space-3);
        box-shadow: var(--shadow-sm);
      }

      .selection-question {
        font-size: 18px;
        font-weight: 600;
        margin: var(--space-3) 0;
        color: var(--text);
      }

      .selection-reason {
        font-size: 14px;
        color: var(--text-muted);
        margin-bottom: var(--space-4);
        line-height: 1.5;
      }

      /* Chips */
      .choice-chips {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
        margin: var(--space-4) 0;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        padding: var(--space-2) var(--space-4);
        border: 1px solid var(--border);
        border-radius: var(--radius-full);
        background: var(--surface-glass);
        backdrop-filter: blur(8px);
        font-size: 14px;
        font-weight: 500;
        color: var(--text);
        cursor: pointer;
        transition: all var(--transition-fast);
        user-select: none;
        white-space: nowrap;
      }

      .chip:hover {
        border-color: var(--border-strong);
        background: var(--surface-glass-hover);
        box-shadow: var(--shadow-sm);
      }

      .chip:active {
        transform: translateY(0) scale(0.98);
      }

      .chip.active {
        background: var(--primary-600);
        border-color: transparent;
        color: white;
        font-weight: 600;
        box-shadow: var(--shadow-purple);
      }

      .chip.active:hover {
        filter: brightness(1.05);
      }

      .subchoices-wrapper {
        margin-left: var(--space-5);
        margin-top: var(--space-2);
      }

      .custom-chip {
        position: relative;
        padding-right: var(--space-6);
        background: hsl(210, 70%, 45%);
      }

      .remove-custom {
        position: absolute;
        right: var(--space-2);
        top: 50%;
        transform: translateY(-50%);
        font-size: 20px;
        font-weight: 700;
        color: white;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity var(--transition-fast);
        line-height: 1;
        padding: 0 var(--space-1);
      }

      .remove-custom:hover {
        opacity: 1;
      }

      .custom-input-wrapper {
        display: flex;
        gap: var(--space-2);
        margin: var(--space-4) 0;
        align-items: center;
      }

      .custom-choice-input {
        flex: 1;
        padding: var(--space-3) var(--space-4);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        background: var(--surface-glass);
        backdrop-filter: blur(8px);
        color: var(--text);
        font-size: 14px;
        font-weight: 500;
        transition: all var(--transition-fast);
      }

      .custom-choice-input:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
      }

      .custom-choice-input::placeholder {
        color: var(--text-muted);
        opacity: 0.6;
      }

      .add-custom-btn {
        padding: var(--space-3) var(--space-5);
        border: none;
        border-radius: var(--radius-md);
        background: hsl(210, 70%, 45%);
        color: white;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-fast);
        white-space: nowrap;
      }

      .add-custom-btn:hover:not(:disabled) {
        box-shadow: var(--shadow-md);
        filter: brightness(1.05);
      }

      .add-custom-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      /* Action buttons in selection */
      .selection-actions {
        display: flex;
        gap: var(--space-3);
        margin-top: var(--space-4);
        flex-wrap: wrap;
      }

      /* Input bar */
      .input-bar {
        padding: var(--space-3);
        border-top: 1px solid var(--border-strong);
        background: hsla(260, 45%, 6%, 0.95);
        backdrop-filter: blur(16px);
      }

      .input-wrapper {
        display: flex;
        gap: var(--space-3);
        align-items: flex-end;
      }

      textarea {
        flex: 1;
        padding: var(--space-3) var(--space-4);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 15px;
        font-family: inherit;
        transition: border-color var(--transition-fast), background var(--transition-fast);
        resize: none;
        min-height: 48px;
        max-height: 120px;
        background: white;
        color: hsl(260, 45%, 10%);
      }

      .domain-hint-input {
        width: 100%;
        padding: var(--space-2) var(--space-3);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 13px;
        font-family: inherit;
        background: white;
        color: hsl(260, 45%, 10%);
      }

      .domain-hint-input::placeholder {
        color: hsl(260, 10%, 50%);
      }

      .domain-hint-input:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px hsla(270, 91%, 65%, 0.15);
      }

      textarea::placeholder {
        color: hsl(260, 10%, 50%);
      }

      textarea:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px hsla(270, 91%, 65%, 0.15);
      }

      /* Buttons */
      button {
        padding: var(--space-3) var(--space-5);
        border: 1px solid var(--border-strong);
        border-radius: var(--radius-md);
        background: var(--surface-glass);
        backdrop-filter: blur(8px);
        cursor: pointer;
        font-size: 15px;
        font-weight: 600;
        font-family: inherit;
        color: var(--text);
        transition: all var(--transition-fast);
        white-space: nowrap;
      }

      button:hover:not(:disabled) {
        transform: translateY(-1px);
        background: var(--surface-glass-hover);
        border-color: var(--primary-500);
        box-shadow: var(--shadow-sm);
      }

      button:active:not(:disabled) {
        transform: translateY(0);
      }

      button.primary {
        background: var(--primary-600);
        color: white;
        border: none;
        box-shadow: var(--shadow-sm);
      }

      button.primary:hover:not(:disabled) {
        filter: brightness(1.05);
        box-shadow: var(--shadow-md);
      }

      button.orange {
        background: hsl(25, 85%, 50%);
        color: white;
        border: none;
        box-shadow: var(--shadow-sm);
        font-weight: 700;
      }

      button.orange:hover:not(:disabled) {
        filter: brightness(1.05);
        box-shadow: var(--shadow-md);
      }

      button.secondary {
        background: hsl(210, 70%, 45%);
        color: white;
        border: none;
        box-shadow: var(--shadow-sm);
        font-weight: 600;
      }

      button.secondary:hover:not(:disabled) {
        filter: brightness(1.05);
        box-shadow: var(--shadow-md);
      }

      button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        transform: none !important;
      }

      /* Summary */
      .summary-card {
        background: var(--surface-glass);
        backdrop-filter: blur(12px);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        margin: var(--space-3) 0;
      }

      .summary-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-muted);
        margin-bottom: var(--space-3);
      }

      .summary-item {
        display: flex;
        gap: var(--space-2);
        margin-bottom: var(--space-2);
        align-items: flex-start;
      }

      .summary-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--primary-500);
        min-width: 100px;
      }

      .summary-value {
        font-size: 13px;
        color: var(--text);
        flex: 1;
      }

      /* Typing indicator */
      .typing-indicator {
        display: flex;
        gap: 6px;
        padding: var(--space-3);
      }

      .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--primary-500);
        animation: typing 1.4s infinite;
      }

      .typing-dot:nth-child(2) { animation-delay: 0.2s; }
      .typing-dot:nth-child(3) { animation-delay: 0.4s; }

      @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
        30% { transform: translateY(-10px); opacity: 1; }
      }

      /* Answer */
      .answer-content {
        background: var(--surface-glass);
        backdrop-filter: blur(12px);
        border: 1px solid var(--border-strong);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        margin: var(--space-3) 0;
        line-height: 1.7;
        position: relative;
      }

      .dig-deeper-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        width: 100%;
        padding: var(--space-3) var(--space-5);
        margin: var(--space-4) 0;
        border: 1px solid var(--border-strong);
        border-radius: var(--radius-md);
        background: var(--surface-glass);
        color: white;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        transition: all var(--transition-fast);
        box-shadow: var(--shadow-sm);
        flex-wrap: wrap;
      }

      .dig-deeper-btn:hover {
        box-shadow: var(--shadow-md);
        filter: brightness(1.05);
      }

      .dig-deeper-btn:active {
        transform: translateY(0);
      }

      .dig-deeper-icon {
        font-size: 18px;
      }

      .dig-deeper-subtitle {
        font-size: 12px;
        font-weight: 500;
        opacity: 0.9;
        margin-left: var(--space-2);
      }

      .answer-actions {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-3);
        margin: var(--space-4) 0;
        padding: var(--space-4);
        background: var(--surface-glass);
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
      }

      .answer-actions button {
        flex: 1;
        min-width: 150px;
      }

      .markdown {
        font-size: 16px;
        line-height: 1.8;
      }

      .markdown h1 {
        font-size: 28px;
        font-weight: 700;
        margin: var(--space-6) 0 var(--space-4);
        color: var(--primary-50);
        letter-spacing: -0.02em;
        border-bottom: 2px solid var(--border-strong);
        padding-bottom: var(--space-3);
      }

      .markdown h2 {
        font-size: 22px;
        font-weight: 700;
        margin: var(--space-5) 0 var(--space-3);
        color: var(--primary-50);
        letter-spacing: -0.01em;
      }

      .markdown h3 {
        font-size: 18px;
        font-weight: 600;
        margin: var(--space-4) 0 var(--space-3);
        color: var(--text);
      }

      .markdown h1:first-child,
      .markdown h2:first-child,
      .markdown h3:first-child {
        margin-top: 0;
      }

      .markdown p { 
        margin: var(--space-4) 0;
        line-height: 1.8;
        color: var(--text);
      }

      .markdown ul, .markdown ol { 
        margin: var(--space-4) 0;
        padding-left: var(--space-6);
        line-height: 1.8;
      }

      .markdown li {
        margin-bottom: var(--space-3);
        color: var(--text);
      }

      .markdown li::marker {
        color: var(--primary-500);
        font-weight: 600;
      }

      .markdown ol li::marker {
        font-weight: 700;
      }

      .markdown strong {
        color: var(--primary-50);
        font-weight: 700;
      }

      .markdown em {
        color: var(--text);
        font-style: italic;
      }

      .markdown code {
        background: var(--surface-glass);
        padding: 2px 6px;
        border-radius: var(--radius-sm);
        font-family: 'Monaco', 'Courier New', monospace;
        font-size: 14px;
        color: var(--accent-cyan);
        border: 1px solid var(--border);
      }

      .markdown pre {
        background: var(--surface-glass);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: var(--space-4);
        margin: var(--space-4) 0;
        overflow-x: auto;
      }

      .markdown pre code {
        background: none;
        padding: 0;
        border: none;
        font-size: 13px;
        color: var(--text);
      }

      .markdown blockquote {
        margin: var(--space-4) 0;
        padding: var(--space-4);
        border-left: 4px solid var(--primary-500);
        background: var(--surface-glass);
        border-radius: 0 var(--radius-md) var(--radius-md) 0;
        font-style: italic;
        color: var(--text-muted);
      }

      .markdown hr {
        border: none;
        border-top: 2px solid var(--border-strong);
        margin: var(--space-6) 0;
      }

      .markdown a {
        color: var(--primary-500);
        text-decoration: none;
        border-bottom: 1px solid transparent;
        transition: border-color var(--transition-fast);
      }

      .markdown a:hover {
        border-bottom-color: var(--primary-500);
      }

      .markdown table {
        width: 100%;
        border-collapse: collapse;
        margin: var(--space-4) 0;
        font-size: 15px;
      }

      .markdown table th,
      .markdown table td {
        border: 1px solid var(--border);
        padding: var(--space-3);
        text-align: left;
      }

      .markdown table th {
        background: var(--surface-glass);
        font-weight: 700;
        color: var(--primary-50);
      }

      .markdown table tr:nth-child(even) {
        background: var(--surface-glass);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .chat-container {
          padding: var(--space-3);
        }

        .chat-header {
          flex-direction: column;
          align-items: stretch;
        }

        .chat-header h1 {
          font-size: 40px;
        }

        .header-content {
          order: 1;
        }

        .header-new-query-btn {
          display: none;
        }

        .message-bubble {
          max-width: 90%;
        }

        .selection-actions {
          flex-direction: column;
        }

        button {
          width: 100%;
        }

        .input-wrapper {
          flex-direction: column;
        }

        textarea {
          width: 100%;
          min-height: 112px !important;
        }

        .input-bar > div {
          flex-direction: row !important;
          align-items: stretch !important;
        }

        .input-bar textarea {
          flex: 1 !important;
        }

        .input-bar button.primary {
          width: 20% !important;
          min-width: 60px !important;
          padding: var(--space-2) !important;
          font-size: 15px !important;
        }
      }

      /* Scrollbar */
      .messages-wrapper::-webkit-scrollbar {
        width: 8px;
      }

      .messages-wrapper::-webkit-scrollbar-track {
        background: transparent;
      }

      .messages-wrapper::-webkit-scrollbar-thumb {
        background: var(--border-strong);
        border-radius: var(--radius-full);
      }

      .messages-wrapper::-webkit-scrollbar-thumb:hover {
        background: var(--primary-500);
      }

      /* Accessibility */
      *:focus-visible {
        outline: 2px solid var(--primary-500);
        outline-offset: 2px;
      }

      /* Loading state */
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }

      button:disabled {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      /* Print styles */
      @media print {
        body {
          background: white;
        }

        .chat-header,
        .input-bar,
        .dig-deeper-btn,
        .answer-actions,
        .header-new-query-btn {
          display: none !important;
        }

        .chat-container {
          max-width: 100%;
          padding: 0;
        }

        .messages-wrapper {
          overflow: visible;
        }

        .message.user .message-bubble {
          background: #f0f0f0;
          color: #333;
          box-shadow: none;
          page-break-inside: avoid;
        }

        .answer-content {
          background: white;
          border: 1px solid #ddd;
          page-break-inside: avoid;
          box-shadow: none;
        }

        .message-bubble {
          page-break-inside: avoid;
        }

        .markdown {
          color: #000;
        }

        .markdown h1,
        .markdown h2,
        .markdown h3 {
          color: #000;
        }

        .summary-card {
          background: #f9f9f9;
          border: 1px solid #ddd;
          page-break-inside: avoid;
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const API_BASE = "";

      function titleCase(value) {
        return String(value)
          .replace(/_/g, " ")
          .split(" ")
          .filter(Boolean)
          .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
          .join(" ");
      }

      function BotMessage({ children }) {
        return (
          <div className="message bot">
            <div className="message-avatar">AI</div>
            <div className="message-bubble">{children}</div>
          </div>
        );
      }

      function UserMessage({ children }) {
        return (
          <div className="message user">
            <div className="message-avatar">YOU</div>
            <div className="message-bubble">{children}</div>
          </div>
        );
      }

      function TypingIndicator() {
        return (
          <div className="message bot">
            <div className="message-avatar">AI</div>
            <div className="message-bubble">
              <div className="typing-indicator">
                <div className="typing-dot"></div>
                <div className="typing-dot"></div>
                <div className="typing-dot"></div>
              </div>
            </div>
          </div>
        );
      }

      function SelectionMessage({ facet, index, total, selections, onSelect, onNext, onSkip, onPickMore, onGetAnswer, isLastAngle, hasSelections, skipMessage, shouldSkip }) {
        const [localSelections, setLocalSelections] = React.useState(new Set());
        const [customInput, setCustomInput] = React.useState("");
        const [customChoices, setCustomChoices] = React.useState(new Set());
        const skippedRef = React.useRef(false);

        React.useEffect(() => {
          const currentSelections = selections[facet.id] || [];
          setLocalSelections(new Set(currentSelections));
          
          // Identify custom choices (not in predefined choices)
          const choices = Array.isArray(facet.choices) ? facet.choices : 
            (facet.suggested_values || []).map((v) => ({ value: v, subchoices: [] }));
          const predefinedValues = new Set();
          choices.forEach(choice => {
            predefinedValues.add(choice.value);
            if (choice.subchoices) {
              choice.subchoices.forEach(sub => {
                predefinedValues.add(`${choice.value} > ${sub}`);
              });
            }
          });
          
          const customs = new Set(currentSelections.filter(sel => !predefinedValues.has(sel)));
          setCustomChoices(customs);
        }, [facet.id, selections]);

        React.useEffect(() => {
          if (shouldSkip && !skippedRef.current) {
            skippedRef.current = true;
            onSkip();
          }
        }, [shouldSkip, onSkip]);

        if (shouldSkip) {
          return (
            <div className="selection-message">
              <div className="selection-question">{skipMessage || "Not applicable. Skipping."}</div>
            </div>
          );
        }

        const toggleSelection = (value) => {
          const newSet = new Set(localSelections);
          if (value === "all options") {
            newSet.clear();
            newSet.add(value);
          } else {
            newSet.delete("all options");
            if (newSet.has(value)) {
              newSet.delete(value);
            } else {
              newSet.add(value);
            }
          }
          setLocalSelections(newSet);
          onSelect(facet.id, Array.from(newSet));
        };

        const removeCustomChoice = (value) => {
          const newSet = new Set(localSelections);
          newSet.delete(value);
          setLocalSelections(newSet);
          
          const newCustoms = new Set(customChoices);
          newCustoms.delete(value);
          setCustomChoices(newCustoms);
          
          onSelect(facet.id, Array.from(newSet));
        };

        const addCustomChoice = () => {
          const trimmed = customInput.trim();
          if (!trimmed) return;
          
          const newSet = new Set(localSelections);
          newSet.delete("all options");
          newSet.add(trimmed);
          setLocalSelections(newSet);
          
          const newCustoms = new Set(customChoices);
          newCustoms.add(trimmed);
          setCustomChoices(newCustoms);
          
          onSelect(facet.id, Array.from(newSet));
          setCustomInput("");
        };

        const handleKeyPress = (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            addCustomChoice();
          }
        };

        const choices = Array.isArray(facet.choices) ? facet.choices : 
          (facet.suggested_values || []).map((v) => ({ value: v, subchoices: [] }));

        return (
          <div className="selection-message">
            <div className="angle-header">Angle {index + 1}/{total}</div>
            <div className="selection-question">{facet.title}</div>
            {facet.question && <div className="selection-reason">{facet.question}</div>}
            {facet.reason && <div className="selection-reason">{facet.reason}</div>}
            
            <div className="choice-chips">
              {choices.map((choice) => {
                const isActive = localSelections.has(choice.value);
                return (
                  <div key={choice.value}>
                    <span
                      className={`chip ${isActive ? "active" : ""}`}
                      onClick={() => toggleSelection(choice.value)}
                    >
                      {titleCase(choice.value)}
                    </span>
                    {choice.subchoices && choice.subchoices.length > 0 && isActive && (
                      <div className="subchoices-wrapper">
                        {choice.subchoices.map((sub) => {
                          const subValue = `${choice.value} > ${sub}`;
                          const subActive = localSelections.has(subValue);
                          return (
                            <span
                              className={`chip ${subActive ? "active" : ""}`}
                              key={sub}
                              onClick={() => toggleSelection(subValue)}
                            >
                              {titleCase(sub)}
                            </span>
                          );
                        })}
                      </div>
                    )}
                  </div>
                );
              })}
              
              {Array.from(customChoices).map((custom) => (
                <span key={custom} className="chip active custom-chip">
                  {titleCase(custom)}
                  <span className="remove-custom" onClick={() => removeCustomChoice(custom)}>×</span>
                </span>
              ))}
            </div>

            <div className="custom-input-wrapper">
              <input
                type="text"
                className="custom-choice-input"
                placeholder="Add your own option..."
                value={customInput}
                onChange={(e) => setCustomInput(e.target.value)}
                onKeyPress={handleKeyPress}
              />
              <button 
                className="add-custom-btn" 
                onClick={addCustomChoice}
                disabled={!customInput.trim()}
              >
                Add
              </button>
            </div>

            <div className="selection-actions">
              <button onClick={onSkip}>Skip</button>
              <button className="primary" onClick={onNext}>
                {isLastAngle ? "Continue →" : "Next →"}
              </button>
            </div>
          </div>
        );
      }

      function SummaryMessage({ selections, facets, clientAnswers, factAnswers }) {
        const allSelections = [];

        Object.entries(selections).forEach(([id, values]) => {
          if (values.length > 0) {
            const facet = facets.find(f => f.id === id);
            const label = facet ? facet.title : id;
            allSelections.push({ label, value: values.join(", ") });
          }
        });

        if (factAnswers && factAnswers.length > 0) {
          allSelections.push({ label: "Fact Answers", value: factAnswers.join("; ") });
        }

        if (clientAnswers && clientAnswers.length > 0) {
          allSelections.push({ label: "Client Answers", value: clientAnswers.join("; ") });
        }

        if (allSelections.length === 0) return null;

        return (
          <div className="summary-card">
            <div className="summary-title">Your Selections:</div>
            {allSelections.map((item, i) => (
              <div key={i} className="summary-item">
                <div className="summary-label">{item.label}:</div>
                <div className="summary-value">{titleCase(item.value)}</div>
              </div>
            ))}
          </div>
        );
      }

      function ClientAnswersMessage({ answers, inputValue, onInputChange, onAddAnswer, onRemoveAnswer }) {
        return (
          <div className="selection-message">
            <div className="selection-question">Client answers (optional)</div>
            <div className="selection-reason">Add any responses provided by the client. These will be used to update the memo and next steps.</div>
            <div className="choice-chips">
              {answers.map((answer, index) => (
                <span key={`${answer}-${index}`} className="chip active custom-chip">
                  {answer}
                  <span className="remove-custom" onClick={() => onRemoveAnswer(index)}>×</span>
                </span>
              ))}
            </div>
            <div className="custom-input-wrapper">
              <input
                type="text"
                className="custom-choice-input"
                placeholder="Add a client answer..."
                value={inputValue}
                onChange={(e) => onInputChange(e.target.value)}
                onKeyPress={(e) => {
                  if (e.key === 'Enter') {
                    e.preventDefault();
                    onAddAnswer();
                  }
                }}
              />
              <button
                className="add-custom-btn"
                onClick={onAddAnswer}
                disabled={!inputValue.trim()}
              >
                Answer
              </button>
            </div>
          </div>
        );
      }

      function FactCasesMessage({
        questions,
        answersByQuestion,
        inputsByQuestion,
        onInputChange,
        onAddAnswer,
        onRemoveAnswer,
        stakesLevel,
        onStakesChange,
        stakesConfirmed,
        onStakesConfirmChange,
        onContinue,
      }) {
        if (!questions || questions.length === 0) {
          return (
            <div className="selection-message">
              <div className="selection-question">No additional fact questions found. Continue to facets.</div>
              <div className="selection-actions" style={{marginTop: 'var(--space-4)', alignItems: 'center'}}>
                <div style={{flex: 1}}>
                  <div style={{fontWeight: 600, marginBottom: 'var(--space-2)'}}>Stakes level</div>
                  <div className="choice-chips">
                    {["Low", "Medium", "High"].map((level) => (
                      <span
                        key={level}
                        className={`chip ${stakesLevel === level ? "active" : ""}`}
                        onClick={() => onStakesChange(level)}
                      >
                        {level}
                      </span>
                    ))}
                  </div>
                  {stakesLevel === "High" && (
                    <label style={{display: 'flex', gap: 'var(--space-2)', alignItems: 'center', marginTop: 'var(--space-2)', fontSize: '13px', color: 'var(--text-muted)'}}>
                      <input
                        type="checkbox"
                        checked={stakesConfirmed}
                        onChange={(e) => onStakesConfirmChange(e.target.checked)}
                      />
                      I confirm key facts are provided or marked unknown.
                    </label>
                  )}
                </div>
                <button
                  className="primary"
                  onClick={onContinue}
                  disabled={stakesLevel === "High" && !stakesConfirmed}
                >
                  Continue to facets
                </button>
              </div>
            </div>
          );
        }

        return (
          <div className="selection-message">
            <div className="selection-question">Fact-case questions</div>
            <div className="selection-reason">Answer any that are available. You can add more later.</div>

            <div style={{display: 'flex', flexDirection: 'column', gap: 'var(--space-4)'}}>
              {questions.map((question) => {
                const answers = answersByQuestion[question] || [];
                const inputValue = inputsByQuestion[question] || "";
                return (
                  <div key={question} style={{padding: 'var(--space-3)', border: '1px solid var(--border)', borderRadius: 'var(--radius-md)'}}>
                    <div style={{fontWeight: 600, marginBottom: 'var(--space-2)'}}>{question}</div>
                    <div className="choice-chips" style={{marginTop: 0}}>
                      {answers.map((answer, index) => (
                        <span key={`${question}-${index}`} className="chip active custom-chip">
                          {answer}
                          <span className="remove-custom" onClick={() => onRemoveAnswer(question, index)}>×</span>
                        </span>
                      ))}
                    </div>
                    <div className="custom-input-wrapper" style={{marginTop: 'var(--space-2)'}}>
                      <input
                        type="text"
                        className="custom-choice-input"
                        placeholder="Add an answer..."
                        value={inputValue}
                        onChange={(e) => onInputChange(question, e.target.value)}
                        onKeyPress={(e) => {
                          if (e.key === 'Enter') {
                            e.preventDefault();
                            onAddAnswer(question);
                          }
                        }}
                      />
                      <button
                        className="add-custom-btn"
                        onClick={() => onAddAnswer(question)}
                        disabled={!inputValue.trim()}
                      >
                        Answer
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>

            <div className="selection-actions" style={{marginTop: 'var(--space-4)', alignItems: 'center'}}>
              <div style={{flex: 1}}>
                <div style={{fontWeight: 600, marginBottom: 'var(--space-2)'}}>Stakes level</div>
                <div className="choice-chips">
                  {["Low", "Medium", "High"].map((level) => (
                    <span
                      key={level}
                      className={`chip ${stakesLevel === level ? "active" : ""}`}
                      onClick={() => onStakesChange(level)}
                    >
                      {level}
                    </span>
                  ))}
                </div>
                {stakesLevel === "High" && (
                  <label style={{display: 'flex', gap: 'var(--space-2)', alignItems: 'center', marginTop: 'var(--space-2)', fontSize: '13px', color: 'var(--text-muted)'}}>
                    <input
                      type="checkbox"
                      checked={stakesConfirmed}
                      onChange={(e) => onStakesConfirmChange(e.target.checked)}
                    />
                    I confirm key facts are provided or marked unknown.
                  </label>
                )}
              </div>
              <button
                className="primary"
                onClick={onContinue}
                disabled={stakesLevel === "High" && !stakesConfirmed}
              >
                Continue to facets
              </button>
            </div>
          </div>
        );
      }

      function AnswerMessage({
        answer,
        onDigDeeper,
        onViewPrompt,
        onViewTrace,
        onProcessAnswers,
        onNewQuery,
        hasReasoning,
        onViewReasoning,
        onPrint,
        unknowns,
        unknownAnswers,
        unknownAnswerInputs,
        onUnknownInputChange,
        onAddUnknownAnswer,
        onRemoveUnknownAnswer,
      }) {
        function escapeHtml(value) {
          return String(value)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        }

        function renderMarkdown(value) {
          const rawLines = String(value || "").split(/\n/);
          const htmlLines = [];
          let inList = false;
          let listType = "ul";
          let inCodeBlock = false;
          let codeBlockLines = [];

          const flushList = () => {
            if (inList) {
              htmlLines.push(listType === "ol" ? "</ol>" : "</ul>");
              inList = false;
            }
          };

          const flushCodeBlock = () => {
            if (inCodeBlock && codeBlockLines.length > 0) {
              htmlLines.push(`<pre><code>${escapeHtml(codeBlockLines.join('\n'))}</code></pre>`);
              codeBlockLines = [];
              inCodeBlock = false;
            }
          };

          const processInlineMarkdown = (text) => {
            let result = escapeHtml(text);
            // Bold
            result = result.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
            // Italic
            result = result.replace(/\*(.+?)\*/g, "<em>$1</em>");
            // Inline code
            result = result.replace(/`([^`]+)`/g, "<code>$1</code>");
            // Links [text](url)
            result = result.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
            return result;
          };

          rawLines.forEach((raw) => {
            const line = raw.trim();
            
            // Code blocks
            if (line.startsWith('```')) {
              if (inCodeBlock) {
                flushCodeBlock();
              } else {
                flushList();
                inCodeBlock = true;
              }
              return;
            }

            if (inCodeBlock) {
              codeBlockLines.push(raw);
              return;
            }

            if (!line) {
              flushList();
              return;
            }

            // Horizontal rule
            if (/^[-*_]{3,}$/.test(line)) {
              flushList();
              htmlLines.push('<hr>');
              return;
            }

            // Headings
            if (/^###\s+/.test(line)) {
              flushList();
              htmlLines.push(`<h3>${processInlineMarkdown(line.replace(/^###\s+/, ""))}</h3>`);
              return;
            }
            if (/^##\s+/.test(line)) {
              flushList();
              htmlLines.push(`<h2>${processInlineMarkdown(line.replace(/^##\s+/, ""))}</h2>`);
              return;
            }
            if (/^#\s+/.test(line)) {
              flushList();
              htmlLines.push(`<h1>${processInlineMarkdown(line.replace(/^#\s+/, ""))}</h1>`);
              return;
            }

            // Blockquotes
            if (/^>\s+/.test(line)) {
              flushList();
              htmlLines.push(`<blockquote>${processInlineMarkdown(line.replace(/^>\s+/, ""))}</blockquote>`);
              return;
            }

            // Ordered lists
            if (/^\d+\.\s+/.test(line)) {
              if (!inList || listType !== "ol") {
                flushList();
                inList = true;
                listType = "ol";
                htmlLines.push("<ol>");
              }
              htmlLines.push(`<li>${processInlineMarkdown(line.replace(/^\d+\.\s+/, ""))}</li>`);
              return;
            }

            // Unordered lists
            if (/^[-*•]\s+/.test(line)) {
              if (!inList || listType !== "ul") {
                flushList();
                inList = true;
                listType = "ul";
                htmlLines.push("<ul>");
              }
              htmlLines.push(`<li>${processInlineMarkdown(line.replace(/^[-*•]\s+/, ""))}</li>`);
              return;
            }

            // Paragraphs
            flushList();
            htmlLines.push(`<p>${processInlineMarkdown(line)}</p>`);
          });

          flushList();
          flushCodeBlock();
          return htmlLines.join("");
        }

        function splitMemoByUnknowns(value) {
          const lines = String(value || "").split(/\n/);
          let startIdx = -1;
          let endIdx = -1;
          for (let i = 0; i < lines.length; i += 1) {
            const line = lines[i].trim();
            if (/^#+\s*/.test(line)) {
              const heading = line.replace(/^#+\s*/, "").toLowerCase();
              if (heading.includes("assumptions") || heading.includes("unknown")) {
                startIdx = i;
                continue;
              }
              if (startIdx !== -1) {
                endIdx = i;
                break;
              }
            }
          }
          if (startIdx === -1) {
            return { before: value, unknowns: [], after: "" };
          }
          if (endIdx === -1) {
            endIdx = lines.length;
          }
          const before = lines.slice(0, startIdx).join("\n");
          const unknownBlock = lines.slice(startIdx + 1, endIdx);
          const after = lines.slice(endIdx).join("\n");
          const unknownItems = [];
          unknownBlock.forEach((rawLine) => {
            const line = rawLine.trim();
            const bulletMatch = line.match(/^[-*•]\s+(.+)/);
            if (bulletMatch) {
              unknownItems.push(bulletMatch[1].trim());
              return;
            }
            const orderedMatch = line.match(/^\d+\.\s+(.+)/);
            if (orderedMatch) {
              unknownItems.push(orderedMatch[1].trim());
            }
          });
          return { before, unknowns: Array.from(new Set(unknownItems)), after };
        }

        const memoSplit = splitMemoByUnknowns(answer);

        return (
          <div className="answer-content">
            <button className="dig-deeper-btn" onClick={onDigDeeper}>
              <span>Dig Deeper</span>
              <span className="dig-deeper-subtitle">(Use answer to apply NEW relevant angles)</span>
            </button>

            <div className="answer-actions">
              {hasReasoning && (
                <button className="secondary" onClick={onViewReasoning}>
                  View Reasoning
                </button>
              )}
              <button className="secondary" onClick={onViewPrompt}>
                View Prompt
              </button>
              <button className="secondary" onClick={onViewTrace}>
                View Trace
              </button>
              <button className="orange" onClick={onProcessAnswers}>
                Process Answers
              </button>
              <button className="primary" onClick={onPrint}>
                Print
              </button>
            </div>

            <div className="markdown" dangerouslySetInnerHTML={{ __html: renderMarkdown(memoSplit.before) }} />

            {(memoSplit.unknowns.length > 0 || unknowns.length > 0) && (
              <div className="markdown" style={{marginTop: 'var(--space-4)'}}>
                <h2>Assumptions &amp; Unknowns</h2>
                <p>
                  Provide answers under each item, then click
                  <strong> Process Answers</strong>.
                </p>
                <div style={{display: 'flex', flexDirection: 'column', gap: 'var(--space-4)'}}>
                  {[...new Set([...(memoSplit.unknowns || []), ...(unknowns || [])])].map((unknown) => {
                    const answers = unknownAnswers[unknown] || [];
                    const inputValue = unknownAnswerInputs[unknown] || "";
                    return (
                      <div key={unknown} style={{padding: 'var(--space-3)', border: '1px solid var(--border)', borderRadius: 'var(--radius-md)'}}>
                        <div style={{fontWeight: 600, marginBottom: 'var(--space-2)'}}>{unknown}</div>
                        <div className="custom-input-wrapper" style={{marginTop: 'var(--space-2)'}}>
                          <input
                            type="text"
                            className="custom-choice-input"
                            placeholder="Add an answer..."
                            value={inputValue}
                            onChange={(e) => onUnknownInputChange(unknown, e.target.value)}
                            onKeyPress={(e) => {
                              if (e.key === 'Enter') {
                                e.preventDefault();
                                onAddUnknownAnswer(unknown);
                              }
                            }}
                          />
                          <button
                            className="add-custom-btn"
                            onClick={() => onAddUnknownAnswer(unknown)}
                            disabled={!inputValue.trim()}
                          >
                            Answer
                          </button>
                        </div>
                        {answers.length > 0 && (
                          <div className="choice-chips" style={{marginTop: 'var(--space-2)'}}>
                            {answers.map((answerItem, index) => (
                              <span key={`${unknown}-${index}`} className="chip active custom-chip">
                                {answerItem}
                                <span className="remove-custom" onClick={() => onRemoveUnknownAnswer(unknown, index)}>×</span>
                              </span>
                            ))}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
                <div className="custom-input-wrapper" style={{marginTop: 'var(--space-3)'}}>
                  <input
                    type="text"
                    className="custom-choice-input"
                    placeholder="Add an assumption or unknown..."
                    value={unknownCustomInput}
                    onChange={(e) => setUnknownCustomInput(e.target.value)}
                    onKeyPress={(e) => {
                      if (e.key === 'Enter') {
                        e.preventDefault();
                        addUnknownItem();
                      }
                    }}
                  />
                  <button
                    className="add-custom-btn"
                    onClick={addUnknownItem}
                    disabled={!unknownCustomInput.trim()}
                  >
                    Add
                  </button>
                </div>
              </div>
            )}

            <div className="markdown" dangerouslySetInnerHTML={{ __html: renderMarkdown(memoSplit.after) }} />

            <div className="answer-actions">
              {hasReasoning && (
                <button className="secondary" onClick={onViewReasoning}>
                  View Reasoning
                </button>
              )}
              <button className="secondary" onClick={onViewPrompt}>
                View Prompt
              </button>
              <button className="secondary" onClick={onViewTrace}>
                View Trace
              </button>
              <button className="orange" onClick={onProcessAnswers}>
                Process Answers
              </button>
              <button className="primary" onClick={onPrint}>
                Print
              </button>
            </div>

            <button className="dig-deeper-btn" onClick={onDigDeeper}>
              <span>Dig Deeper</span>
              <span className="dig-deeper-subtitle">(Use answer to apply NEW relevant angles)</span>
            </button>
          </div>
        );
      }

      function App() {
        const [messages, setMessages] = React.useState([]);
        const [conversationState, setConversationState] = React.useState("initial");
        const [query, setQuery] = React.useState("");
        const [domainHint, setDomainHint] = React.useState("");
        const [requestId, setRequestId] = React.useState(null);
        const [facets, setFacets] = React.useState([]);
        const [factQuestions, setFactQuestions] = React.useState([]);
        const [factAnswers, setFactAnswers] = React.useState({});
        const [factAnswerInputs, setFactAnswerInputs] = React.useState({});
        const [stakesLevel, setStakesLevel] = React.useState("Medium");
        const [stakesConfirmed, setStakesConfirmed] = React.useState(false);
        const [currentAngleIndex, setCurrentAngleIndex] = React.useState(0);
        const [selections, setSelections] = React.useState({});
        const [clientAnswers, setClientAnswers] = React.useState([]);
        const [clientAnswerInput, setClientAnswerInput] = React.useState("");
        const [unknowns, setUnknowns] = React.useState([]);
        const [unknownAnswers, setUnknownAnswers] = React.useState({});
        const [unknownAnswerInputs, setUnknownAnswerInputs] = React.useState({});
        const [unknownCustomInput, setUnknownCustomInput] = React.useState("");
        const [loading, setLoading] = React.useState(false);
        const [trace, setTrace] = React.useState([]);
        const [compiledPrompt, setCompiledPrompt] = React.useState(null);
        const [modelReasoning, setModelReasoning] = React.useState(null);
        const messagesEndRef = React.useRef(null);
        const answerRef = React.useRef(null);
        const lastAddedMessageRef = React.useRef(null);

        const scrollToBottom = () => {
          messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
        };

        const scrollToAnswer = () => {
          answerRef.current?.scrollIntoView({ behavior: "smooth", block: "start" });
        };

        const scrollToLastMessage = () => {
          lastAddedMessageRef.current?.scrollIntoView({ behavior: "smooth", block: "start" });
        };

        const scrollToReasoningPrompt = () => {
          reasoningPromptRef.current?.scrollIntoView({ behavior: "smooth", block: "start" });
        };

        React.useEffect(() => {
          // Scroll to bottom when new messages are added (except on initial load)
          const lastMessage = messages[messages.length - 1];
          // Skip auto-scroll for initial instructions message
          if (lastMessage && conversationState !== "initial") {
            setTimeout(() => scrollToBottom(), 100);
          }
        }, [messages.length]); // Only trigger on message count change, not content change

        React.useEffect(() => {
          // Welcome message
          setMessages([
            { type: "bot", content: "Hi! I'm Legal, your AI assistant with a laser focus." },
            { type: "bot", content: { type: "instructions" } }
          ]);
        }, []);

        const addMessage = (type, content) => {
          setMessages(prev => [...prev, { type, content }]);
        };

        const handleQuerySubmit = async () => {
          if (!query.trim()) return;

          addMessage("user", query);
          setLastQuery(query.trim());
          setConversationState("processing_query");
          setLoading(true);

          addMessage("bot", <TypingIndicator />);

          try {
            const res = await fetch(`${API_BASE}/api/discover`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                raw_query: query.trim(),
                domain_hint: domainHint.trim() || null,
              }),
            });

            if (!res.ok) {
              throw new Error("Failed to discover angles");
            }

            const data = await res.json();
            setRequestId(data.request_id);
            setFacets([]);
            setFactQuestions(data.fact_questions || []);
            setFactAnswers({});
            setFactAnswerInputs({});
            setStakesLevel("Medium");
            setStakesConfirmed(false);
            setCurrentAngleIndex(0);

            // Remove typing indicator
            setMessages(prev => prev.slice(0, -1));

            addMessage("bot", "First, let's capture the key case facts:");
            addMessage("bot", { type: "fact_cases" });
            setConversationState("fact_cases");
          } catch (err) {
            setMessages(prev => prev.slice(0, -1));
            addMessage("bot", "Sorry, I encountered an error. Please try again.");
          } finally {
            setLoading(false);
            setQuery("");
            setDomainHint("");
          }
        };

        const handleBaseSelectionsConfirm = () => {
          addMessage("bot", "Let's explore the angles:");
          setConversationState("showing_angles");
          setCurrentAngleIndex(0);

          if (facets.length > 0) {
            addMessage("bot", { type: "selection", facetIndex: 0 });
          }
        };

        const handleSelection = (facetId, values) => {
          setSelections(prev => ({ ...prev, [facetId]: values }));
        };

        const updateFactAnswerInput = (question, value) => {
          setFactAnswerInputs(prev => ({ ...prev, [question]: value }));
        };

        const addFactAnswer = (question) => {
          const inputValue = (factAnswerInputs[question] || "").trim();
          if (!inputValue) return;
          setFactAnswers(prev => {
            const existing = prev[question] || [];
            return { ...prev, [question]: [...existing, inputValue] };
          });
          setFactAnswerInputs(prev => ({ ...prev, [question]: "" }));
        };

        const removeFactAnswer = (question, index) => {
          setFactAnswers(prev => {
            const existing = prev[question] || [];
            return { ...prev, [question]: existing.filter((_, i) => i !== index) };
          });
        };

        const flattenFactAnswers = () => {
          const result = [];
          Object.entries(factAnswers).forEach(([question, answers]) => {
            answers.forEach((answer) => {
              if (String(answer).trim()) {
                result.push(`${question}: ${answer}`);
              }
            });
          });
          return result;
        };

        const extractUnknowns = (answerText) => {
          const lines = String(answerText || "").split(/\n/);
          const normalized = (value) => String(value || "").trim();
          const items = [];
          let inUnknowns = false;
          for (const rawLine of lines) {
            const line = normalized(rawLine);
            if (/^#+\s*/.test(line)) {
              const heading = line.replace(/^#+\s*/, "").toLowerCase();
              if (heading.includes("assumptions") || heading.includes("unknown")) {
                inUnknowns = true;
                continue;
              }
              if (inUnknowns) {
                break;
              }
            }
            if (!inUnknowns) continue;
            const bulletMatch = line.match(/^[-*•]\s+(.+)/);
            if (bulletMatch) {
              items.push(bulletMatch[1].trim());
              continue;
            }
            const orderedMatch = line.match(/^\d+\.\s+(.+)/);
            if (orderedMatch) {
              items.push(orderedMatch[1].trim());
              continue;
            }
            if (line) {
              items.push(line);
            }
          }
          return Array.from(new Set(items)).filter(Boolean);
        };

        const updateUnknownInput = (question, value) => {
          setUnknownAnswerInputs(prev => ({ ...prev, [question]: value }));
        };

        const addUnknownAnswer = (question) => {
          const inputValue = (unknownAnswerInputs[question] || "").trim();
          if (!inputValue) return;
          setUnknownAnswers(prev => {
            const existing = prev[question] || [];
            return { ...prev, [question]: [...existing, inputValue] };
          });
          setUnknownAnswerInputs(prev => ({ ...prev, [question]: "" }));
        };

        const removeUnknownAnswer = (question, index) => {
          setUnknownAnswers(prev => {
            const existing = prev[question] || [];
            return { ...prev, [question]: existing.filter((_, i) => i !== index) };
          });
        };

        const flattenUnknownAnswers = () => {
          const result = [];
          Object.entries(unknownAnswers).forEach(([question, answers]) => {
            answers.forEach((answer) => {
              if (String(answer).trim()) {
                result.push(`Unknown: ${question}: ${answer}`);
              }
            });
          });
          return result;
        };

        const addUnknownItem = () => {
          const trimmed = unknownCustomInput.trim();
          if (!trimmed) return;
          if (unknowns.includes(trimmed)) {
            setUnknownCustomInput("");
            return;
          }
          setUnknowns(prev => [...prev, trimmed]);
          setUnknownAnswers(prev => ({ ...prev, [trimmed]: [] }));
          setUnknownAnswerInputs(prev => ({ ...prev, [trimmed]: "" }));
          setUnknownCustomInput("");
        };

        const handleFactCasesContinue = () => {
          addMessage("bot", "Generating memo angles based on the case facts...");
          setLoading(true);
          addMessage("bot", <TypingIndicator />);

          const factAnswerList = flattenFactAnswers();
          const factSelections = [];
          if (factQuestions.length > 0) {
            factSelections.push({ id: "fact_questions", value: factQuestions.join("; ") });
          }
          if (factAnswerList.length > 0) {
            factSelections.push({ id: "fact_answers", value: factAnswerList.join("; ") });
          }

          fetch(`${API_BASE}/api/refine`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              request_id: requestId,
              facet_selections: factSelections,
              refine_round: 2,
              exclude_facet_ids: [],
            }),
          })
            .then((res) => {
              if (!res.ok) {
                throw new Error("Failed to generate facets");
              }
              return res.json();
            })
            .then((data) => {
              const nextFacets = data.facet_candidates || [];
              setMessages(prev => prev.slice(0, -1));
              setFacets(nextFacets);
              addMessage("bot", "Thanks. Let's move to the memo angles:");
              setConversationState("showing_angles");
              setCurrentAngleIndex(0);
              if (nextFacets.length > 0) {
                addMessage("bot", { type: "selection", facetIndex: 0 });
              } else {
                addMessage("bot", "No relevant angles found. You can proceed to generate the memo.");
                addMessage("bot", { type: "summary" });
                addMessage("bot", { type: "client_answers" });
                addMessage("bot", { type: "ready_to_answer_actions" });
                setConversationState("ready_to_answer");
              }
            })
            .catch(() => {
              setMessages(prev => prev.slice(0, -1));
              addMessage("bot", "Sorry, I couldn't generate memo angles. Please try again.");
            })
            .finally(() => {
              setLoading(false);
            });
        };

        const addClientAnswer = () => {
          const trimmed = clientAnswerInput.trim();
          if (!trimmed) return;
          setClientAnswers(prev => [...prev, trimmed]);
          setClientAnswerInput("");
        };

        const removeClientAnswer = (index) => {
          setClientAnswers(prev => prev.filter((_, i) => i !== index));
        };

        const handleNextAngle = () => {
          addMessage("bot", "Got it! ✓");
          
          if (currentAngleIndex < facets.length - 1) {
            const nextIndex = currentAngleIndex + 1;
            setCurrentAngleIndex(nextIndex);
            addMessage("bot", { type: "selection", facetIndex: nextIndex });
          } else {
            handleAllAnglesCompleted();
          }
        };

        const handleSkipAngle = () => {
          addMessage("bot", "Skipped. Moving on...");
          
          if (currentAngleIndex < facets.length - 1) {
            const nextIndex = currentAngleIndex + 1;
            setCurrentAngleIndex(nextIndex);
            addMessage("bot", { type: "selection", facetIndex: nextIndex });
          } else {
            handleAllAnglesCompleted();
          }
        };

        const handleAllAnglesCompleted = () => {
          addMessage("bot", { type: "summary" });
          addMessage("bot", { type: "client_answers" });
          addMessage("bot", "All angles covered! Ready to get your answer!");
          addMessage("bot", { type: "ready_to_answer_actions" });
          setConversationState("ready_to_answer");
        };

        const handlePickMoreAngles = async () => {
          if (!requestId) return;

          addMessage("bot", "Looking for more angles...");
          setLoading(true);
          addMessage("bot", <TypingIndicator />);

          try {
            const apiSelections = [];
            Object.entries(selections).forEach(([id, values]) => {
              if (values.length > 0) apiSelections.push({ id, value: values.join(", ") });
            });
            if (stakesLevel) {
              apiSelections.push({ id: "stakes_level", value: stakesLevel });
            }

            const res = await fetch(`${API_BASE}/api/refine`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                request_id: requestId,
                facet_selections: apiSelections,
                refine_round: 2,
                exclude_facet_ids: facets.map(f => f.id),  // Don't suggest already-shown facets
              }),
            });

            if (!res.ok) {
              throw new Error("Failed to refine");
            }

            const data = await res.json();
            const newFacets = data.facet_candidates || [];

            setMessages(prev => prev.slice(0, -1));

            if (newFacets.length > 0) {
              const oldLength = facets.length;
              setFacets(prev => [...prev, ...newFacets]);
              addMessage("bot", `Found ${newFacets.length} more angles! Let's explore them:`);
              
              const nextIndex = oldLength;
              setCurrentAngleIndex(nextIndex);
              addMessage("bot", { type: "selection", facetIndex: nextIndex });
              setConversationState("showing_angles");
            } else {
              addMessage("bot", "No additional angles found. Ready to get your answer!");
            }
          } catch (err) {
            setMessages(prev => prev.slice(0, -1));
            addMessage("bot", "Sorry, I couldn't find more angles. Please try again.");
          } finally {
            setLoading(false);
          }
        };

        const handleGetAnswer = async () => {
          if (!requestId) return;

          addMessage("bot", "Generating your answer...");
          setLoading(true);
          addMessage("bot", <TypingIndicator />);

          try {
            const apiSelections = [];
            Object.entries(selections).forEach(([id, values]) => {
              if (values.length > 0) apiSelections.push({ id, value: values.join(", ") });
            });

            const res = await fetch(`${API_BASE}/api/answer`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                request_id: requestId,
                facet_selections: apiSelections,
                fact_questions: factQuestions,
                fact_answers: flattenFactAnswers(),
                client_answers: [...clientAnswers, ...flattenUnknownAnswers()],
                user_overrides: null,
              }),
            });

            if (!res.ok) {
              throw new Error("Failed to get answer");
            }

            const data = await res.json();

            setMessages(prev => prev.slice(0, -1));
            
            // Add explainer showing how selections shaped the answer
            addMessage("bot", "How your selections shaped this answer:");
            addMessage("bot", { type: "selection_explainer" });
            
            addMessage("bot", "Here's your answer:");
            addMessage("bot", { type: "answer", answer: data.answer });
            setTrace(data.trace || []);
            setCompiledPrompt(data.compiled_prompt || null);
            setModelReasoning(data.reasoning || null);

            const nextUnknowns = extractUnknowns(data.answer);
            setUnknowns(nextUnknowns);
            setUnknownAnswers(prev => {
              const next = {};
              nextUnknowns.forEach((item) => {
                next[item] = prev[item] || [];
              });
              return next;
            });
            setUnknownAnswerInputs(prev => {
              const next = {};
              nextUnknowns.forEach((item) => {
                next[item] = prev[item] || "";
              });
              return next;
            });
            
            setConversationState("answer_shown");
            
            // Scroll to the answer after a short delay to ensure it's rendered
            setTimeout(() => scrollToAnswer(), 200);
          } catch (err) {
            setMessages(prev => prev.slice(0, -1));
            addMessage("bot", "Sorry, I couldn't generate an answer. Please try again.");
          } finally {
            setLoading(false);
          }
        };

        const handleNewQuery = () => {
          setMessages([
            { type: "bot", content: "Hi! I'm Legal, your AI assistant with a laser focus." },
            { type: "bot", content: { type: "instructions" } }
          ]);
          setConversationState("initial");
          setQuery("");
          setDomainHint("");
          setRequestId(null);
          setFacets([]);
          setFactQuestions([]);
          setFactAnswers({});
          setFactAnswerInputs({});
          setStakesLevel("Medium");
          setStakesConfirmed(false);
          setCurrentAngleIndex(0);
          setSelections({});
          setClientAnswers([]);
          setClientAnswerInput("");
          setUnknowns([]);
          setUnknownAnswers({});
          setUnknownAnswerInputs({});
          setUnknownCustomInput("");
        };

        const handlePrintAnswer = (answerText, queryText, selectionsData) => {
          let selectionsHtml = '';

          // Create print document
          const printContent = `
            <!DOCTYPE html>
            <html>
              <head>
                <title>Legal Answer</title>
                <style>
                  body { 
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
                    line-height: 1.6;
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 40px 20px;
                    color: #333;
                  }
                  h1 { color: #8b5cf6; margin-bottom: 10px; }
                  h2 { color: #666; margin-top: 30px; }
                  h3 { color: #8b5cf6; }
                  .query { 
                    font-size: 18px; 
                    font-weight: 600; 
                    margin: 20px 0;
                    padding: 15px;
                    background: #f9f9f9;
                    border-left: 4px solid #8b5cf6;
                  }
                  .answer { margin-top: 30px; }
                  code { 
                    background: #f5f5f5; 
                    padding: 2px 6px; 
                    border-radius: 3px;
                    font-family: monospace;
                  }
                  pre {
                    background: #f5f5f5;
                    padding: 15px;
                    border-radius: 5px;
                    overflow-x: auto;
                  }
                  pre code { background: none; padding: 0; }
                  @media print {
                    body { padding: 20px; }
                  }
                </style>
              </head>
              <body>
                <h1>Legal</h1>
                <p style="color: #666; font-style: italic;">AI with a laser focus</p>
                <div class="query">
                  <strong>Query:</strong> ${queryText || 'N/A'}
                </div>
                ${selectionsHtml}
                <div class="answer">
                  <h2>Answer</h2>
                  ${answerText}
                </div>
              </body>
            </html>
          `;

          // Create iframe for printing (stays on current page)
          const iframe = document.createElement('iframe');
          iframe.style.position = 'absolute';
          iframe.style.width = '0';
          iframe.style.height = '0';
          iframe.style.border = 'none';
          document.body.appendChild(iframe);

          const iframeDoc = iframe.contentWindow.document;
          iframeDoc.open();
          iframeDoc.write(printContent);
          iframeDoc.close();

          // Print and cleanup
          setTimeout(() => {
            iframe.contentWindow.print();
            setTimeout(() => {
              document.body.removeChild(iframe);
            }, 100);
          }, 250);
        };

        const handleDigDeeper = async (answerText) => {
          addMessage("user", "Dig deeper into this answer");
          addMessage("bot", "Great! Let's explore this answer from different angles...");
          setLoading(true);
          addMessage("bot", <TypingIndicator />);

          try {
            const res = await fetch(`${API_BASE}/api/discover`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                raw_query: answerText,
                domain_hint: null,
              }),
            });

            if (!res.ok) {
              throw new Error("Failed to discover angles");
            }

            const data = await res.json();
            setRequestId(data.request_id);
            setFacets([]);
            setFactQuestions(data.fact_questions || []);
            setFactAnswers({});
            setFactAnswerInputs({});
            setStakesLevel("Medium");
            setStakesConfirmed(false);
            setCurrentAngleIndex(0);
            setSelections({});
            setClientAnswers([]);
            setClientAnswerInput("");
            setUnknowns([]);
            setUnknownAnswers({});
            setUnknownAnswerInputs({});
            setUnknownCustomInput("");

            // Remove typing indicator
            setMessages(prev => prev.slice(0, -1));

            addMessage("bot", "Let's capture the key facts for this follow-up:");
            addMessage("bot", { type: "fact_cases" });
            setConversationState("fact_cases");
          } catch (err) {
            setMessages(prev => prev.slice(0, -1));
            addMessage("bot", "Sorry, I encountered an error. Please try again.");
          } finally {
            setLoading(false);
          }
        };

        const [lastQuery, setLastQuery] = React.useState("");

        const renderMessage = (msg, index) => {
          if (msg.type === "bot") {
            if (typeof msg.content === "string") {
              return <BotMessage key={index}>{msg.content}</BotMessage>;
            } else if (msg.content?.type === "base_selections") {
              return (
                <div key={index} className="selection-message">
                  <div className="selection-question">Preferences are fixed for this workflow.</div>
                  <div className="summary-card" style={{marginTop: 'var(--space-3)'}}>
                    <div className="summary-item">
                      <div className="summary-label">Depth:</div>
                      <div className="summary-value">Executive</div>
                    </div>
                    <div className="summary-item">
                      <div className="summary-label">Format:</div>
                      <div className="summary-value">Memo</div>
                    </div>
                  </div>
                </div>
              );
            } else if (msg.content?.type === "selection") {
              const facet = facets[msg.content.facetIndex];
              if (!facet) return null;
              const workerSelections = selections["worker_classification"] || [];
              const isEmployee = workerSelections.some((value) =>
                String(value).toLowerCase().includes("employee")
              );
              const shouldSkip = facet.id === "contract_type" && !isEmployee;
              return (
                <SelectionMessage
                  key={index}
                  facet={facet}
                  index={msg.content.facetIndex}
                  total={facets.length}
                  selections={selections}
                  onSelect={handleSelection}
                  onNext={handleNextAngle}
                  onSkip={handleSkipAngle}
                  onPickMore={handlePickMoreAngles}
                  onGetAnswer={handleGetAnswer}
                  isLastAngle={msg.content.facetIndex === facets.length - 1}
                  hasSelections={Object.keys(selections).length > 0}
                  shouldSkip={shouldSkip}
                  skipMessage="Contract type is only required for employees. Skipping."
                />
              );
            } else if (msg.content?.type === "summary") {
              return (
                <SummaryMessage
                  key={index}
                  selections={selections}
                  facets={facets}
                  clientAnswers={clientAnswers}
                  factAnswers={flattenFactAnswers()}
                />
              );
            } else if (msg.content?.type === "fact_cases") {
              return (
                <FactCasesMessage
                  key={index}
                  questions={factQuestions}
                  answersByQuestion={factAnswers}
                  inputsByQuestion={factAnswerInputs}
                  onInputChange={updateFactAnswerInput}
                  onAddAnswer={addFactAnswer}
                  onRemoveAnswer={removeFactAnswer}
                  stakesLevel={stakesLevel}
                  onStakesChange={setStakesLevel}
                  stakesConfirmed={stakesConfirmed}
                  onStakesConfirmChange={setStakesConfirmed}
                  onContinue={handleFactCasesContinue}
                />
              );
            } else if (msg.content?.type === "client_answers") {
              return (
                <ClientAnswersMessage
                  key={index}
                  answers={clientAnswers}
                  inputValue={clientAnswerInput}
                  onInputChange={setClientAnswerInput}
                  onAddAnswer={addClientAnswer}
                  onRemoveAnswer={removeClientAnswer}
                />
              );
            } else if (msg.content?.type === "editable_summary") {
              // Editable summary with all selections displayed as chips
              return (
                <div key={index} className="selection-message">
                  <div className="summary-title" style={{marginBottom: 'var(--space-4)', fontSize: '16px', fontWeight: 600}}>
                    Your Current Selections - Click any to edit:
                  </div>

                  {/* Angle Selections */}
                  {facets.map((facet, facetIndex) => {
                    const facetSelections = selections[facet.id];
                    if (!facetSelections || facetSelections.length === 0) return null;

                    // Parse selections to show parent/child hierarchy
                    const tree = {};
                    facetSelections.forEach((val) => {
                      if (val.includes(" > ")) {
                        const [parent, child] = val.split(" > ").map((v) => v.trim());
                        if (!tree[parent]) tree[parent] = { children: [] };
                        if (!tree[parent].children.includes(child)) tree[parent].children.push(child);
                      } else {
                        if (!tree[val]) tree[val] = { children: [] };
                      }
                    });

                    return (
                      <div key={facet.id} style={{marginBottom: 'var(--space-5)', padding: 'var(--space-4)', background: 'var(--surface-glass)', borderRadius: 'var(--radius-md)', border: '1px solid var(--border)'}}>
                        <div style={{
                          fontWeight: 600,
                          color: 'var(--primary-500)',
                          marginBottom: 'var(--space-3)',
                          fontSize: '15px',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'space-between'
                        }}>
                          <span>{facet.title}</span>
                          <button
                            style={{
                              padding: '4px 12px',
                              fontSize: '12px',
                              background: 'var(--surface-glass-hover)',
                              border: '1px solid var(--border-strong)',
                              borderRadius: 'var(--radius-full)',
                              cursor: 'pointer',
                              color: 'var(--text)',
                              fontWeight: 600
                            }}
                            onClick={() => {
                              setCurrentAngleIndex(facetIndex);
                              addMessage("bot", `Let's review ${facet.title}:`);
                              addMessage("bot", { type: "selection", facetIndex: facetIndex });
                              setConversationState("showing_angles");
                            }}
                          >
                            Edit
                          </button>
                        </div>
                        <div>
                          {Object.entries(tree).map(([parent, data]) => (
                            <div key={parent} style={{marginBottom: 'var(--space-2)'}}>
                              <span 
                                className="chip active" 
                                style={{cursor: 'pointer'}}
                                onClick={() => {
                                  setCurrentAngleIndex(facetIndex);
                                  addMessage("bot", `Let's review ${facet.title}:`);
                                  addMessage("bot", { type: "selection", facetIndex: facetIndex });
                                  setConversationState("showing_angles");
                                }}
                              >
                                {titleCase(parent)}
                              </span>
                              {data.children.length > 0 && (
                                <div style={{marginLeft: 'var(--space-5)', marginTop: 'var(--space-2)', display: 'flex', flexWrap: 'wrap', gap: 'var(--space-2)'}}>
                                  {data.children.map((child) => (
                                    <span 
                                      className="chip active" 
                                      key={child}
                                      style={{cursor: 'pointer'}}
                                      onClick={() => {
                                        setCurrentAngleIndex(facetIndex);
                                        addMessage("bot", `Let's review ${facet.title}:`);
                                        addMessage("bot", { type: "selection", facetIndex: facetIndex });
                                        setConversationState("showing_angles");
                                      }}
                                    >
                                      {titleCase(child)}
                                    </span>
                                  ))}
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      </div>
                    );
                  })}

                  <div className="selection-actions" style={{marginTop: 'var(--space-5)'}}>
                    <button className="orange" onClick={handlePickMoreAngles} disabled={loading}>
                      Pick More Angles
                    </button>
                    <button className="primary" onClick={handleGetAnswer} disabled={loading}>
                      Regenerate Answer
                    </button>
                  </div>
                </div>
              );
            } else if (msg.content?.type === "ready_to_answer_actions") {
              return (
                <div key={index} className="selection-message">
                  <div className="selection-actions">
                      <button className="orange" onClick={handleGetAnswer} disabled={loading}>
                        Process Answers
                      </button>
                  </div>
                </div>
              );
            } else if (msg.content?.type === "answer") {
              return (
                <div key={index} ref={answerRef}>
                  <AnswerMessage 
                    answer={msg.content.answer} 
                    onDigDeeper={() => handleDigDeeper(msg.content.answer)}
                    hasReasoning={modelReasoning !== null}
                    onViewReasoning={() => {
                      const hasReasoningMsg = messages.some(m => m.content?.type === "model_reasoning");
                      if (!hasReasoningMsg && modelReasoning) {
                        addMessage("bot", "Here's the model's internal reasoning process:");
                        addMessage("bot", { type: "model_reasoning", reasoningData: modelReasoning });
                        setTimeout(() => scrollToLastMessage(), 200);
                      }
                    }}
                    onViewPrompt={() => {
                      const hasPrompt = messages.some(m => m.content?.type === "compiled_prompt");
                      if (!hasPrompt && compiledPrompt) {
                        addMessage("bot", "Here's the exact prompt sent to the AI:");
                        addMessage("bot", { type: "compiled_prompt", promptData: compiledPrompt });
                        setTimeout(() => scrollToLastMessage(), 200);
                      }
                    }}
                    onViewTrace={() => {
                      const hasTrace = messages.some(m => m.content?.type === "trace");
                      if (!hasTrace && trace) {
                        addMessage("bot", "Here's the complete trace of how I processed your query:");
                        addMessage("bot", { type: "trace", traceData: trace });
                        setTimeout(() => scrollToLastMessage(), 200);
                      }
                    }}
                    onProcessAnswers={handleGetAnswer}
                    onNewQuery={handleNewQuery}
                    onPrint={() => handlePrintAnswer(msg.content.answer, lastQuery, selections)}
                    unknowns={unknowns}
                    unknownAnswers={unknownAnswers}
                    unknownAnswerInputs={unknownAnswerInputs}
                    onUnknownInputChange={updateUnknownInput}
                    onAddUnknownAnswer={addUnknownAnswer}
                    onRemoveUnknownAnswer={removeUnknownAnswer}
                  />
                </div>
              );
            } else if (msg.content?.type === "model_reasoning") {
              const reasoning = msg.content.reasoningData;
              const isLastMessage = index === messages.length - 1;
              return (
                <div key={index} ref={isLastMessage ? lastAddedMessageRef : null} className="answer-content" style={{padding: 'var(--space-5)'}}>
                  <div style={{
                    fontWeight: 700,
                    fontSize: '14px',
                    color: 'var(--accent-cyan)',
                    marginBottom: 'var(--space-3)',
                    display: 'flex',
                    alignItems: 'center',
                    gap: 'var(--space-2)'
                  }}>
                    Model's Internal Reasoning (o1)
                  </div>
                  <div style={{
                    fontSize: '14px',
                    color: 'var(--text)',
                    lineHeight: 1.7,
                    whiteSpace: 'pre-wrap',
                    background: 'var(--surface-glass)',
                    padding: 'var(--space-4)',
                    borderRadius: 'var(--radius-md)',
                    border: '1px solid var(--border)'
                  }}>
                    {reasoning}
                  </div>
                  <div style={{
                    marginTop: 'var(--space-3)',
                    fontSize: '13px',
                    color: 'var(--text-muted)',
                    fontStyle: 'italic'
                  }}>
                    This is the model's chain-of-thought process before generating the final answer.
                  </div>
                </div>
              );
            } else if (msg.content?.type === "compiled_prompt") {
              const prompt = msg.content.promptData;
              const isLastMessage = index === messages.length - 1;
              if (!prompt || !prompt.sections) {
                return (
                  <div key={index} ref={isLastMessage ? lastAddedMessageRef : null} className="answer-content">
                    <p>Prompt data not available.</p>
                  </div>
                );
              }

              return (
                <div key={index} ref={isLastMessage ? lastAddedMessageRef : null} className="answer-content" style={{padding: 0}}>
                  {prompt.sections.map((section, sIdx) => (
                    <div key={sIdx} style={{
                      marginBottom: sIdx < prompt.sections.length - 1 ? 'var(--space-4)' : 0,
                      padding: 'var(--space-4)',
                      background: sIdx % 2 === 0 ? 'var(--surface-glass)' : 'transparent',
                      borderRadius: 'var(--radius-md)',
                      border: '1px solid var(--border)'
                    }}>
                      <div style={{
                        fontWeight: 700,
                        fontSize: '13px',
                        color: 'var(--primary-500)',
                        textTransform: 'uppercase',
                        letterSpacing: '0.05em',
                        marginBottom: 'var(--space-2)'
                      }}>
                        {section.title}
                      </div>
                      <div style={{
                        fontSize: '14px',
                        color: 'var(--text)',
                        lineHeight: 1.7,
                        whiteSpace: 'pre-wrap',
                        fontFamily: section.title === 'Instructions' ? 'inherit' : 'monospace'
                      }}>
                        {section.content}
                      </div>
                    </div>
                  ))}
                </div>
              );
            } else if (msg.content?.type === "trace") {
              const isLastMessage = index === messages.length - 1;
              return (
                <div key={index} ref={isLastMessage ? lastAddedMessageRef : null} className="answer-content" style={{fontFamily: 'monospace', fontSize: '13px'}}>
                  <pre style={{whiteSpace: 'pre-wrap', margin: 0, lineHeight: 1.6}}>
                    {JSON.stringify(msg.content.traceData, null, 2)}
                  </pre>
                </div>
              );
            } else if (msg.content?.type === "instructions") {
              return (
                <div key={index} className="selection-message" style={{background: 'var(--bot-bg)', border: '1px solid var(--border)'}}>
                  <div style={{display: 'flex', flexDirection: 'column', gap: 'var(--space-3)', alignItems: 'center'}}>
                    <div style={{display: 'flex', gap: 'var(--space-2)', alignItems: 'center'}}>
                      <div style={{fontWeight: 600, fontSize: '15px'}}>Ask anything</div>
                    </div>
                    <div style={{display: 'flex', gap: 'var(--space-2)', alignItems: 'center'}}>
                      <div style={{fontWeight: 600, fontSize: '15px'}}>Pick what matters</div>
                    </div>
                    <div style={{display: 'flex', gap: 'var(--space-2)', alignItems: 'center'}}>
                      <div style={{fontWeight: 600, fontSize: '15px'}}>Get your perfect answer</div>
                    </div>
                  </div>
                  <div style={{marginTop: 'var(--space-4)', fontSize: '16px', fontWeight: 600, color: 'var(--text)', textAlign: 'center'}}>
                    Exactly What You Want to Know!
                  </div>
                </div>
              );
            } else if (msg.content?.type === "selection_explainer") {
              // Explainer showing how selections shaped the answer
              const explainers = [];
              
              // Add topic-specific angle impacts
              Object.entries(selections).forEach(([facetId, values]) => {
                if (values && values.length > 0) {
                  const facet = facets.find(f => f.id === facetId);
                  const facetTitle = facet ? facet.title : titleCase(facetId);
                  const valueStr = values.map(v => titleCase(v)).join(", ");
                  explainers.push({
                    label: facetTitle,
                    value: valueStr,
                    impact: "Emphasizing these aspects while filtering out less relevant information"
                  });
                }
              });

              return (
                <div key={index} className="summary-card">
                  {explainers.map((item, i) => (
                    <div key={i} style={{marginBottom: 'var(--space-3)'}}>
                      <div style={{fontWeight: 600, fontSize: '14px', color: 'var(--primary-500)', marginBottom: 'var(--space-1)'}}>
                        • {item.label} ({item.value})
                      </div>
                      <div style={{fontSize: '14px', color: 'var(--text-muted)', paddingLeft: 'var(--space-4)'}}>
                        {item.impact}
                      </div>
                    </div>
                  ))}
                </div>
              );
            } else {
              return <BotMessage key={index}>{msg.content}</BotMessage>;
            }
          } else if (msg.type === "user") {
            return <UserMessage key={index}>{msg.content}</UserMessage>;
          }
          return null;
        };

        return (
          <div className="chat-container">
            <div className="chat-header">
              <div className="header-content">
                <h1 onClick={handleNewQuery} title="Go to landing page">Legal</h1>
                <div className="tagline">Ask once, get exactly what you need. AI with a laser focus.</div>
              </div>
              <button className="header-new-query-btn" onClick={handleNewQuery}>
                + New Query
              </button>
            </div>

            <div className="messages-wrapper">
              {messages.map((msg, i) => renderMessage(msg, i))}
              <div ref={messagesEndRef} />
            </div>

            {(conversationState === "initial" || conversationState === "answer_shown") && (
              <div className="input-bar">
                <div style={{display: 'flex', gap: 'var(--space-4)', alignItems: 'center'}}>
                  <div style={{flex: 1, display: 'flex', flexDirection: 'column', gap: 'var(--space-2)'}}>
                    <textarea
                      value={query}
                      onChange={(e) => setQuery(e.target.value)}
                      placeholder="Ask anything..."
                      onKeyDown={(e) => {
                        if (e.key === "Enter" && !e.shiftKey) {
                          e.preventDefault();
                          handleQuerySubmit();
                        }
                      }}
                      style={{flex: 1, minHeight: '72px', maxHeight: '120px'}}
                    />
                    <input
                      className="domain-hint-input"
                      type="text"
                      value={domainHint}
                      onChange={(e) => setDomainHint(e.target.value)}
                      placeholder="Domain hint (optional): employment_us, employment law"
                    />
                  </div>
                  <button className="primary" onClick={handleQuerySubmit} disabled={loading || !query.trim()} style={{padding: 'var(--space-4) var(--space-6)', alignSelf: 'stretch', minHeight: '72px'}}>
                    ASK
                  </button>
                </div>
              </div>
            )}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
